

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>trebl_tools package &mdash; TREBL Tools 0.1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=9edc463e" />

  
      <script src="_static/jquery.js?v=5d32c60e"></script>
      <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="_static/documentation_options.js?v=01f34227"></script>
      <script src="_static/doctools.js?v=fd6eb6e6"></script>
      <script src="_static/sphinx_highlight.js?v=6ffebe34"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="trebl_tools" href="modules.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            TREBL Tools
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">User Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="user_guide/introduction.html">What is TREBL?</a></li>
<li class="toctree-l1"><a class="reference internal" href="user_guide/installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="user_guide/preprocessing.html">Preprocessing Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="user_guide/analysis_setup.html">Analysis Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="user_guide/step1.html">Step 1: TREBL Mapping</a></li>
<li class="toctree-l1"><a class="reference internal" href="user_guide/step2.html">Step 2: TREBL Step 2 Mapping</a></li>
<li class="toctree-l1"><a class="reference internal" href="user_guide/trebl_experiment.html">TREBL Experiment with UMIs</a></li>
<li class="toctree-l1"><a class="reference internal" href="user_guide/advanced_usage.html">Advanced Usage</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Documentation</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="modules.html">trebl_tools</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">trebl_tools package</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#submodules">Submodules</a></li>
<li class="toctree-l3"><a class="reference internal" href="#module-trebl_tools.complexity">trebl_tools.complexity module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#trebl_tools.complexity.ComplexityChecker"><code class="docutils literal notranslate"><span class="pre">ComplexityChecker</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#module-trebl_tools.error_correct">trebl_tools.error_correct module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#trebl_tools.error_correct.concatenate_fastqs"><code class="docutils literal notranslate"><span class="pre">concatenate_fastqs()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#trebl_tools.error_correct.convert_txt_to_whitelist_mapping_df_from_path"><code class="docutils literal notranslate"><span class="pre">convert_txt_to_whitelist_mapping_df_from_path()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#trebl_tools.error_correct.rc_and_swap"><code class="docutils literal notranslate"><span class="pre">rc_and_swap()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#trebl_tools.error_correct.run_whitelist_on_concat_domains"><code class="docutils literal notranslate"><span class="pre">run_whitelist_on_concat_domains()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#module-trebl_tools.finder">trebl_tools.finder module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#trebl_tools.finder.Barcode"><code class="docutils literal notranslate"><span class="pre">Barcode</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#trebl_tools.finder.add_barcode"><code class="docutils literal notranslate"><span class="pre">add_barcode()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#trebl_tools.finder.add_multiple_barcodes"><code class="docutils literal notranslate"><span class="pre">add_multiple_barcodes()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#trebl_tools.finder.add_umi"><code class="docutils literal notranslate"><span class="pre">add_umi()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#module-trebl_tools.initial_map">trebl_tools.initial_map module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#trebl_tools.initial_map.InitialMapper"><code class="docutils literal notranslate"><span class="pre">InitialMapper</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#module-trebl_tools.map_refiner">trebl_tools.map_refiner module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#trebl_tools.map_refiner.MapRefiner"><code class="docutils literal notranslate"><span class="pre">MapRefiner</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#module-trebl_tools.pipelines">trebl_tools.pipelines module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#trebl_tools.pipelines.TreblPipeline"><code class="docutils literal notranslate"><span class="pre">TreblPipeline</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#module-trebl_tools.plotting">trebl_tools.plotting module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#trebl_tools.plotting.plot_all_whitelists_from_summary"><code class="docutils literal notranslate"><span class="pre">plot_all_whitelists_from_summary()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#trebl_tools.plotting.plot_error_correction"><code class="docutils literal notranslate"><span class="pre">plot_error_correction()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#trebl_tools.plotting.plot_loss_helper"><code class="docutils literal notranslate"><span class="pre">plot_loss_helper()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#trebl_tools.plotting.plot_reads_histogram"><code class="docutils literal notranslate"><span class="pre">plot_reads_histogram()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#module-trebl_tools.preprocess">trebl_tools.preprocess module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#trebl_tools.preprocess.fastp_summary_df"><code class="docutils literal notranslate"><span class="pre">fastp_summary_df()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#trebl_tools.preprocess.load_and_shorten_files"><code class="docutils literal notranslate"><span class="pre">load_and_shorten_files()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#trebl_tools.preprocess.reverse_complement"><code class="docutils literal notranslate"><span class="pre">reverse_complement()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#trebl_tools.preprocess.reverse_complement_series"><code class="docutils literal notranslate"><span class="pre">reverse_complement_series()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#trebl_tools.preprocess.run_fastp"><code class="docutils literal notranslate"><span class="pre">run_fastp()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#trebl_tools.preprocess.save_parquet"><code class="docutils literal notranslate"><span class="pre">save_parquet()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#trebl_tools.preprocess.shorten_seq_file"><code class="docutils literal notranslate"><span class="pre">shorten_seq_file()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#trebl_tools.preprocess.time_it"><code class="docutils literal notranslate"><span class="pre">time_it()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#module-trebl_tools.umi_deduplicate">trebl_tools.umi_deduplicate module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#trebl_tools.umi_deduplicate.UMIDeduplicator"><code class="docutils literal notranslate"><span class="pre">UMIDeduplicator</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#module-trebl_tools">Module contents</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#trebl_tools.TreblPipeline"><code class="docutils literal notranslate"><span class="pre">TreblPipeline</span></code></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">TREBL Tools</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="modules.html">trebl_tools</a></li>
      <li class="breadcrumb-item active">trebl_tools package</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/trebl_tools.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="trebl-tools-package">
<h1>trebl_tools package<a class="headerlink" href="#trebl-tools-package" title="Link to this heading"></a></h1>
<section id="submodules">
<h2>Submodules<a class="headerlink" href="#submodules" title="Link to this heading"></a></h2>
</section>
<section id="module-trebl_tools.complexity">
<span id="trebl-tools-complexity-module"></span><h2>trebl_tools.complexity module<a class="headerlink" href="#module-trebl_tools.complexity" title="Link to this heading"></a></h2>
<dl class="py class">
<dt class="sig sig-object py" id="trebl_tools.complexity.ComplexityChecker">
<span class="property"><span class="k"><span class="pre">class</span></span><span class="w"> </span></span><span class="sig-prename descclassname"><span class="pre">trebl_tools.complexity.</span></span><span class="sig-name descname"><span class="pre">ComplexityChecker</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">db_path</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">step_name</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">step1_map_name</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">step_suffix</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">barcode_groups</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/trebl_tools/complexity.html#ComplexityChecker"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#trebl_tools.complexity.ComplexityChecker" title="Link to this definition"></a></dt>
<dd><p>Bases: <code class="xref py py-class docutils literal notranslate"><span class="pre">object</span></code></p>
<p>Analyze barcode complexity and coverage between different processing steps.</p>
<p>This class compares barcode sequences between the initial mapping table
(designed sequences) and processed datasets to assess library coverage,
identify missing sequences, and evaluate processing efficiency.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>db_path</strong> (<em>str</em>) – Path to the DuckDB database containing mapping tables.</p></li>
<li><p><strong>step_name</strong> (<em>str</em>) – Identifier for the processing step being analyzed.</p></li>
<li><p><strong>step1_map_name</strong> (<em>str</em>) – Name of the initial mapping table in the database
containing the designed barcode sequences.</p></li>
<li><p><strong>step_suffix</strong> (<em>str</em>) – Suffix of the processed table to compare against
the initial mapping (e.g., “quality_designed”).</p></li>
<li><p><strong>barcode_groups</strong> (<em>list</em>) – List of barcode groups to analyze. Each group
can be either a single Barcode object or a list of Barcode objects
for multi-barcode analyses.</p></li>
</ul>
</dd>
</dl>
<p class="rubric">Example</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Single barcode analysis</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">bc1</span> <span class="o">=</span> <span class="n">Barcode</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;AD_BC&quot;</span><span class="p">,</span> <span class="n">preceder</span><span class="o">=</span><span class="s2">&quot;ATCG&quot;</span><span class="p">,</span> <span class="n">post</span><span class="o">=</span><span class="s2">&quot;GCTA&quot;</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">bc2</span> <span class="o">=</span> <span class="n">Barcode</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;REP_BC&quot;</span><span class="p">,</span> <span class="n">preceder</span><span class="o">=</span><span class="s2">&quot;TTAA&quot;</span><span class="p">,</span> <span class="n">post</span><span class="o">=</span><span class="s2">&quot;GGCC&quot;</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># Multi-barcode combination analysis</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">checker</span> <span class="o">=</span> <span class="n">ComplexityChecker</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">db_path</span><span class="o">=</span><span class="s2">&quot;experiment.duckdb&quot;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">step_name</span><span class="o">=</span><span class="s2">&quot;step2&quot;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">step1_map_name</span><span class="o">=</span><span class="s2">&quot;step1_AD_ADBC_RTBC_quality_designed&quot;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">step_suffix</span><span class="o">=</span><span class="s2">&quot;quality_designed&quot;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">barcode_groups</span><span class="o">=</span><span class="p">[</span><span class="n">bc1</span><span class="p">,</span> <span class="n">bc2</span><span class="p">,</span> <span class="p">[</span><span class="n">bc1</span><span class="p">,</span> <span class="n">bc2</span><span class="p">]]</span>  <span class="c1"># Individual + combined</span>
<span class="gp">... </span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># Analyze coverage</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">coverage_df</span> <span class="o">=</span> <span class="n">checker</span><span class="o">.</span><span class="n">count_overlap</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">coverage_df</span><span class="p">)</span>
<span class="go">      BC_type  map_unique  step2  seen_in_both  percent_of_map_seen</span>
<span class="go">0       AD_BC        1000    800           750                 75.0</span>
<span class="go">1      REP_BC         500    400           350                 70.0</span>
<span class="go">2  AD_BC,REP_BC       1500   1200          1100                 73.3</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Requires that both the initial mapping table and processed tables
exist in the connected DuckDB database. Barcode objects must have
a ‘name’ attribute for SQL column identification.</p>
</div>
<dl class="py method">
<dt class="sig sig-object py" id="trebl_tools.complexity.ComplexityChecker.__init__">
<span class="sig-name descname"><span class="pre">__init__</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">db_path</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">step_name</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">step1_map_name</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">step_suffix</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">barcode_groups</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/trebl_tools/complexity.html#ComplexityChecker.__init__"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#trebl_tools.complexity.ComplexityChecker.__init__" title="Link to this definition"></a></dt>
<dd><p>Initialize ComplexityChecker with database connection and analysis parameters.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>db_path</strong> (<em>str</em>) – Path to DuckDB database file.</p></li>
<li><p><strong>step_name</strong> (<em>str</em>) – Processing step identifier.</p></li>
<li><p><strong>step1_map_name</strong> (<em>str</em>) – Initial mapping table name.</p></li>
<li><p><strong>step_suffix</strong> (<em>str</em>) – Processed table suffix.</p></li>
<li><p><strong>barcode_groups</strong> (<em>list</em>) – List of barcode groups for analysis.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="trebl_tools.complexity.ComplexityChecker.count_overlap">
<span class="sig-name descname"><span class="pre">count_overlap</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="_modules/trebl_tools/complexity.html#ComplexityChecker.count_overlap"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#trebl_tools.complexity.ComplexityChecker.count_overlap" title="Link to this definition"></a></dt>
<dd><p>Calculate overlap statistics for a single barcode group.</p>
<p>Compares unique barcode combinations between the initial mapping table
and a processed table to determine coverage and overlap metrics.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>barcode_group</strong> (<em>list</em><em>[</em><a class="reference internal" href="#trebl_tools.finder.Barcode" title="trebl_tools.finder.Barcode"><em>Barcode</em></a><em>]</em>) – List of Barcode objects to analyze
as a group. For single barcode analysis, pass a list with one element.</p>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p><dl class="simple">
<dt>DataFrame with a single row containing:</dt><dd><ul class="simple">
<li><p>BC_type (str): Comma-separated list of barcode names in the group</p></li>
<li><p>map_unique (int): Number of unique barcode combinations in initial mapping</p></li>
<li><p>{step_name} (int): Number of unique combinations in processed table</p></li>
<li><p>seen_in_both (int): Number of combinations found in both tables</p></li>
</ul>
</dd>
</dl>
</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>pd.DataFrame</p>
</dd>
</dl>
<p class="rubric">Example</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">bc_group</span> <span class="o">=</span> <span class="p">[</span><span class="n">ad_bc</span><span class="p">,</span> <span class="n">rep_bc</span><span class="p">]</span>  <span class="c1"># Two-barcode combination</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">overlap_df</span> <span class="o">=</span> <span class="n">checker</span><span class="o">.</span><span class="n">count_overlap_one_barcode_group</span><span class="p">(</span><span class="n">bc_group</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">overlap_df</span><span class="p">)</span>
<span class="go">  BC_type  map_unique  step2  seen_in_both</span>
<span class="go">0  AD_BC,REP_BC    1500    1200          1100</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Constructs table names using the pattern: {step_name}_{barcode_names}_{step_suffix}
Uses DISTINCT counts to avoid duplicate sequences in the analysis.</p>
</div>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="trebl_tools.complexity.ComplexityChecker.count_overlap_one_barcode_group">
<span class="sig-name descname"><span class="pre">count_overlap_one_barcode_group</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">barcode_group</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/trebl_tools/complexity.html#ComplexityChecker.count_overlap_one_barcode_group"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#trebl_tools.complexity.ComplexityChecker.count_overlap_one_barcode_group" title="Link to this definition"></a></dt>
<dd></dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="trebl_tools.complexity.ComplexityChecker.show_tables">
<span class="sig-name descname"><span class="pre">show_tables</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="_modules/trebl_tools/complexity.html#ComplexityChecker.show_tables"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#trebl_tools.complexity.ComplexityChecker.show_tables" title="Link to this definition"></a></dt>
<dd><p>Display all tables in the connected DuckDB database.</p>
<p>Prints a list of all table names in the database for reference
and debugging purposes.</p>
<p class="rubric">Example</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">checker</span><span class="o">.</span><span class="n">show_tables</span><span class="p">()</span>
<span class="go">(&#39;step1_map&#39;,)</span>
<span class="go">(&#39;step2_AD_BC_quality_designed&#39;,)</span>
<span class="go">(&#39;step2_REP_BC_quality_designed&#39;,)</span>
</pre></div>
</div>
</dd></dl>

</dd></dl>

</section>
<section id="module-trebl_tools.error_correct">
<span id="trebl-tools-error-correct-module"></span><h2>trebl_tools.error_correct module<a class="headerlink" href="#module-trebl_tools.error_correct" title="Link to this heading"></a></h2>
<dl class="py function">
<dt class="sig sig-object py" id="trebl_tools.error_correct.concatenate_fastqs">
<span class="sig-prename descclassname"><span class="pre">trebl_tools.error_correct.</span></span><span class="sig-name descname"><span class="pre">concatenate_fastqs</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">input_fastq_list</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">output_dir</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/trebl_tools/error_correct.html#concatenate_fastqs"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#trebl_tools.error_correct.concatenate_fastqs" title="Link to this definition"></a></dt>
<dd><p>Concatenate multiple FASTQ files into a single temporary file.</p>
<p>Combines multiple FASTQ files into one temporary file for batch processing
with UMI-tools. Handles both single file inputs and lists of files.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>input_fastq_list</strong> (<em>str</em><em> or </em><em>list</em><em>[</em><em>str</em><em>]</em>) – Path to single FASTQ file or list
of FASTQ file paths to concatenate.</p></li>
<li><p><strong>output_dir</strong> (<em>str</em><em> or </em><em>Path</em>) – Directory where temporary concatenated file
will be created.</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p><dl class="simple">
<dt>Path to the concatenated FASTQ file. If input was a single file,</dt><dd><p>returns the original file path unchanged.</p>
</dd>
</dl>
</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>str</p>
</dd>
</dl>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Creates a temporary file named “tmp_combined.fastq” in the output directory.</p>
</div>
<p class="rubric">Example</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;sample1.fastq&quot;</span><span class="p">,</span> <span class="s2">&quot;sample2.fastq&quot;</span><span class="p">,</span> <span class="s2">&quot;sample3.fastq&quot;</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">combined_path</span> <span class="o">=</span> <span class="n">concatenate_fastqs</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="s2">&quot;temp_dir/&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Combined file: </span><span class="si">{</span><span class="n">combined_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="go">Combined file: temp_dir/tmp_combined.fastq</span>
<span class="go">Done in 5.23 seconds.</span>
</pre></div>
</div>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="trebl_tools.error_correct.convert_txt_to_whitelist_mapping_df_from_path">
<span class="sig-prename descclassname"><span class="pre">trebl_tools.error_correct.</span></span><span class="sig-name descname"><span class="pre">convert_txt_to_whitelist_mapping_df_from_path</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">whitelist_path</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/trebl_tools/error_correct.html#convert_txt_to_whitelist_mapping_df_from_path"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#trebl_tools.error_correct.convert_txt_to_whitelist_mapping_df_from_path" title="Link to this definition"></a></dt>
<dd><p>Convert UMI-tools whitelist output to sequence mapping DataFrame.</p>
<p>Reads a UMI-tools whitelist text file and creates a mapping DataFrame
that shows the relationship between original sequences and their
canonical (corrected) forms for downstream error correction.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>whitelist_path</strong> (<em>str</em><em> or </em><em>Path</em>) – Path to the whitelist text file generated
by UMI-tools. Expected format: tab-separated with columns
[canonical, collapsed, largest_count, counts].</p>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p><dl class="simple">
<dt>Mapping DataFrame with columns:</dt><dd><ul class="simple">
<li><p>”original”: Original sequence (canonical or collapsed)</p></li>
<li><p>”canonical”: Canonical sequence this original maps to</p></li>
</ul>
</dd>
</dl>
</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>pd.DataFrame</p>
</dd>
</dl>
<p class="rubric">Example</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">mapping_df</span> <span class="o">=</span> <span class="n">convert_txt_to_whitelist_mapping_df_from_path</span><span class="p">(</span><span class="s2">&quot;whitelist.txt&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">mapping_df</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>
<span class="go">       original    canonical</span>
<span class="go">0  ATCGATCGATCG  ATCGATCGATCG</span>
<span class="go">1  ATCGATCGATCT  ATCGATCGATCG</span>
<span class="go">2  ATCGATCGATTG  ATCGATCGATCG</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Each canonical sequence maps to itself, and all sequences listed in the
“collapsed” column map to their corresponding canonical sequence.
Currently hardcoded to not perform reverse complement transformation.</p>
</div>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="trebl_tools.error_correct.rc_and_swap">
<span class="sig-prename descclassname"><span class="pre">trebl_tools.error_correct.</span></span><span class="sig-name descname"><span class="pre">rc_and_swap</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">preceder</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">post</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">length</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">int)</span> <span class="pre">-&gt;</span> <span class="pre">(&lt;class</span> <span class="pre">'str'&gt;</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">&lt;class</span> <span class="pre">'str'&gt;</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/trebl_tools/error_correct.html#rc_and_swap"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#trebl_tools.error_correct.rc_and_swap" title="Link to this definition"></a></dt>
<dd><p>Generate reverse complement patterns for barcode extraction.</p>
<p>Transforms preceder and post patterns for reverse complement mode by
reverse complementing and swapping their positions. This is used when
sequences need to be processed in reverse orientation.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>preceder</strong> (<em>str</em>) – Original DNA sequence pattern that precedes the barcode.</p></li>
<li><p><strong>post</strong> (<em>str</em>) – Original DNA sequence pattern that follows the barcode.</p></li>
<li><p><strong>length</strong> (<em>int</em>) – Length parameter (currently unused but maintained for compatibility).</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p><dl class="simple">
<dt>A tuple containing:</dt><dd><ul class="simple">
<li><p>preceder_rc (str): Reverse complement of the original post sequence</p></li>
<li><p>post_rc (str): Reverse complement of the original preceder sequence</p></li>
</ul>
</dd>
</dl>
</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>tuple[str, str]</p>
</dd>
</dl>
<p class="rubric">Example</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">preceder</span><span class="p">,</span> <span class="n">post</span> <span class="o">=</span> <span class="s2">&quot;ATCG&quot;</span><span class="p">,</span> <span class="s2">&quot;GCTA&quot;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">rc_preceder</span><span class="p">,</span> <span class="n">rc_post</span> <span class="o">=</span> <span class="n">rc_and_swap</span><span class="p">(</span><span class="n">preceder</span><span class="p">,</span> <span class="n">post</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;RC preceder: </span><span class="si">{</span><span class="n">rc_preceder</span><span class="si">}</span><span class="s2">, RC post: </span><span class="si">{</span><span class="n">rc_post</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="go">RC preceder: TAGC, RC post: CGAT</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The swap occurs because in reverse complement orientation, the roles
of preceder and post patterns are reversed.</p>
</div>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="trebl_tools.error_correct.run_whitelist_on_concat_domains">
<span class="sig-prename descclassname"><span class="pre">trebl_tools.error_correct.</span></span><span class="sig-name descname"><span class="pre">run_whitelist_on_concat_domains</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">fastq_path</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">output_dir</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">set_cell_number</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">prefix</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/trebl_tools/error_correct.html#run_whitelist_on_concat_domains"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#trebl_tools.error_correct.run_whitelist_on_concat_domains" title="Link to this definition"></a></dt>
<dd><p>Execute UMI-tools whitelist on concatenated barcode sequences.</p>
<p>Runs UMI-tools whitelist algorithm on a FASTQ file containing extracted
and concatenated barcode sequences to identify canonical sequences and
group similar sequences for error correction.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>fastq_path</strong> (<em>str</em><em> or </em><em>Path</em>) – Path to FASTQ file containing extracted barcodes.</p></li>
<li><p><strong>output_dir</strong> (<em>str</em><em> or </em><em>Path</em>) – Directory to save whitelist outputs including
log files, whitelist text files, and diagnostic plots.</p></li>
<li><p><strong>set_cell_number</strong> (<em>int</em><em>, </em><em>optional</em>) – Force a specific number of expected
cell barcodes instead of using automatic knee detection. Defaults to None.</p></li>
<li><p><strong>prefix</strong> (<em>str</em><em>, </em><em>optional</em>) – Prefix for output file naming. If None, uses
the FASTQ filename stem. Defaults to None.</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p><dl class="simple">
<dt>Dictionary with paths to generated files:</dt><dd><ul class="simple">
<li><p>”log”: Path to the whitelist log file</p></li>
<li><p>”whitelist”: Path to the whitelist text output file</p></li>
<li><p>”plot_prefix”: Prefix for generated diagnostic plots</p></li>
</ul>
</dd>
</dl>
</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>dict</p>
</dd>
<dt class="field-even">Raises<span class="colon">:</span></dt>
<dd class="field-even"><p><strong>subprocess.CalledProcessError</strong> – If UMI-tools whitelist command fails.</p>
</dd>
</dl>
<p class="rubric">Example</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">result</span> <span class="o">=</span> <span class="n">run_whitelist_on_concat_domains</span><span class="p">(</span>
<span class="gp">... </span>    <span class="s2">&quot;barcodes.fastq&quot;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="s2">&quot;output/&quot;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">set_cell_number</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;sample1&quot;</span>
<span class="gp">... </span><span class="p">)</span>
<span class="go">Running umi_tools whitelist on barcodes.fastq ...</span>
<span class="go">Whitelist complete.</span>
<span class="go">- Log: output/sample1_whitelist.log</span>
<span class="go">- Output: output/sample1_whitelist.txt</span>
<span class="go">- Plots: output/sample1_plots_*.png</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Uses density-based knee detection method by default. The barcode pattern
“(?P&lt;umi_1&gt;.{1})(?P&lt;cell_1&gt;.*)” extracts the entire sequence as cell barcode
with a single dummy UMI base. Requires UMI-tools conda environment.</p>
</div>
</dd></dl>

</section>
<section id="module-trebl_tools.finder">
<span id="trebl-tools-finder-module"></span><h2>trebl_tools.finder module<a class="headerlink" href="#module-trebl_tools.finder" title="Link to this heading"></a></h2>
<dl class="py class">
<dt class="sig sig-object py" id="trebl_tools.finder.Barcode">
<span class="property"><span class="k"><span class="pre">class</span></span><span class="w"> </span></span><span class="sig-prename descclassname"><span class="pre">trebl_tools.finder.</span></span><span class="sig-name descname"><span class="pre">Barcode</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">name</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">preceder</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">post</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">length</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/trebl_tools/finder.html#Barcode"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#trebl_tools.finder.Barcode" title="Link to this definition"></a></dt>
<dd><p>Bases: <code class="xref py py-class docutils literal notranslate"><span class="pre">object</span></code></p>
<p>Represents a barcode with extraction pattern specifications.</p>
<p>This class defines the parameters needed to extract a specific barcode
from DNA sequences, including the flanking sequences and expected length.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>name</strong> (<em>str</em>) – Identifier for the barcode that will be used as column name.</p></li>
<li><p><strong>preceder</strong> (<em>str</em>) – DNA sequence pattern that precedes the barcode.</p></li>
<li><p><strong>post</strong> (<em>str</em>) – DNA sequence pattern that follows the barcode.</p></li>
<li><p><strong>length</strong> (<em>int</em>) – Expected length of the barcode sequence.</p></li>
</ul>
</dd>
</dl>
<p class="rubric">Example</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Create a barcode object for a 20bp sequence between &quot;ATCG&quot; and &quot;GCTA&quot;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ad_barcode</span> <span class="o">=</span> <span class="n">Barcode</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;AD_BC&quot;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">preceder</span><span class="o">=</span><span class="s2">&quot;ATCG&quot;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">post</span><span class="o">=</span><span class="s2">&quot;GCTA&quot;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">length</span><span class="o">=</span><span class="mi">20</span>
<span class="gp">... </span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Barcode: </span><span class="si">{</span><span class="n">ad_barcode</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">, Length: </span><span class="si">{</span><span class="n">ad_barcode</span><span class="o">.</span><span class="n">length</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="go">Barcode: AD_BC, Length: 20</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The preceder and post sequences are used in regex pattern matching,
so special regex characters should be escaped if they appear literally
in the DNA sequences.</p>
</div>
<dl class="py method">
<dt class="sig sig-object py" id="trebl_tools.finder.Barcode.__init__">
<span class="sig-name descname"><span class="pre">__init__</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">name</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">preceder</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">post</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">length</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/trebl_tools/finder.html#Barcode.__init__"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#trebl_tools.finder.Barcode.__init__" title="Link to this definition"></a></dt>
<dd><p>Initialize a Barcode object with extraction parameters.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>name</strong> (<em>str</em>) – Barcode identifier for column naming.</p></li>
<li><p><strong>preceder</strong> (<em>str</em>) – DNA sequence preceding the barcode.</p></li>
<li><p><strong>post</strong> (<em>str</em>) – DNA sequence following the barcode.</p></li>
<li><p><strong>length</strong> (<em>int</em>) – Expected length of barcode sequence.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="trebl_tools.finder.add_barcode">
<span class="sig-prename descclassname"><span class="pre">trebl_tools.finder.</span></span><span class="sig-name descname"><span class="pre">add_barcode</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">seq_df</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">bc_object</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/trebl_tools/finder.html#add_barcode"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#trebl_tools.finder.add_barcode" title="Link to this definition"></a></dt>
<dd><p>Extract a barcode from sequences using pattern matching.</p>
<p>Extracts barcode sequences located between specified preceder and post
patterns. Creates both the barcode column and a quality flag column
indicating whether the extracted sequence matches the expected length.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>seq_df</strong> (<em>pd.DataFrame</em><em> or </em><em>dask.DataFrame</em>) – DataFrame containing a ‘sequence’ column
with DNA sequences to process.</p></li>
<li><p><strong>bc_object</strong> (<a class="reference internal" href="#trebl_tools.finder.Barcode" title="trebl_tools.finder.Barcode"><em>Barcode</em></a>) – Barcode object containing extraction parameters
(name, preceder, post, length).</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p><dl class="simple">
<dt>Updated DataFrame with two new columns:</dt><dd><ul class="simple">
<li><p>{bc_object.name}: Extracted barcode sequences</p></li>
<li><p>{bc_object.name}_qual: Boolean quality flag (True if length matches expected)</p></li>
</ul>
</dd>
</dl>
</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>pd.DataFrame or dask.DataFrame</p>
</dd>
</dl>
<p class="rubric">Example</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;sequence&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;AAAXXXCCC&quot;</span><span class="p">,</span> <span class="s2">&quot;AAAYYYCCC&quot;</span><span class="p">,</span> <span class="s2">&quot;AAAXCCC&quot;</span><span class="p">]})</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">bc</span> <span class="o">=</span> <span class="n">Barcode</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;TEST&quot;</span><span class="p">,</span> <span class="n">preceder</span><span class="o">=</span><span class="s2">&quot;AAA&quot;</span><span class="p">,</span> <span class="n">post</span><span class="o">=</span><span class="s2">&quot;CCC&quot;</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">result_df</span> <span class="o">=</span> <span class="n">add_barcode</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">bc</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">result_df</span><span class="p">)</span>
<span class="go">   sequence TEST  TEST_qual</span>
<span class="go">0  AAAXXXCCC  XXX       True</span>
<span class="go">1  AAAYYYCCC  YYY       True</span>
<span class="go">2    AAAXCCC    X      False</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Uses greedy regex matching by default. Sequences that don’t match
the pattern or don’t meet the length requirement will have NaN
values that are converted to False for the quality flag.</p>
</div>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="trebl_tools.finder.add_multiple_barcodes">
<span class="sig-prename descclassname"><span class="pre">trebl_tools.finder.</span></span><span class="sig-name descname"><span class="pre">add_multiple_barcodes</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">bc_objects</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">seq_df</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/trebl_tools/finder.html#add_multiple_barcodes"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#trebl_tools.finder.add_multiple_barcodes" title="Link to this definition"></a></dt>
<dd><p>Extract multiple barcodes from sequences in a single operation.</p>
<p>Applies barcode extraction for all specified barcode objects to the
input DataFrame. This is a convenience function for processing multiple
barcodes in a batch operation.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>bc_objects</strong> (<em>list</em><em>[</em><a class="reference internal" href="#trebl_tools.finder.Barcode" title="trebl_tools.finder.Barcode"><em>Barcode</em></a><em>]</em>) – List of Barcode objects defining the
barcodes to extract.</p></li>
<li><p><strong>seq_df</strong> (<em>pd.DataFrame</em><em> or </em><em>dask.DataFrame</em>) – DataFrame containing sequences
in a ‘sequence’ column.</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p><dl class="simple">
<dt>Updated DataFrame with columns for</dt><dd><p>each extracted barcode and corresponding quality flags:
- {barcode.name}: Extracted barcode sequence
- {barcode.name}_qual: Boolean quality flag for each barcode</p>
</dd>
</dl>
</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>pd.DataFrame or dask.DataFrame</p>
</dd>
</dl>
<p class="rubric">Example</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;sequence&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;AAAXXXCCCYYYTTT&quot;</span><span class="p">,</span> <span class="s2">&quot;AAAABBBCCCDDTTT&quot;</span><span class="p">]})</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">bc1</span> <span class="o">=</span> <span class="n">Barcode</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;BC1&quot;</span><span class="p">,</span> <span class="n">preceder</span><span class="o">=</span><span class="s2">&quot;AAA&quot;</span><span class="p">,</span> <span class="n">post</span><span class="o">=</span><span class="s2">&quot;CCC&quot;</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">bc2</span> <span class="o">=</span> <span class="n">Barcode</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;BC2&quot;</span><span class="p">,</span> <span class="n">preceder</span><span class="o">=</span><span class="s2">&quot;CCC&quot;</span><span class="p">,</span> <span class="n">post</span><span class="o">=</span><span class="s2">&quot;TTT&quot;</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">result_df</span> <span class="o">=</span> <span class="n">add_multiple_barcodes</span><span class="p">([</span><span class="n">bc1</span><span class="p">,</span> <span class="n">bc2</span><span class="p">],</span> <span class="n">df</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">result_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
<span class="go">[&#39;sequence&#39;, &#39;BC1&#39;, &#39;BC1_qual&#39;, &#39;BC2&#39;, &#39;BC2_qual&#39;]</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Barcodes are processed sequentially in the order provided.
Creates a copy of the input DataFrame to avoid modifying the original.
Each barcode extraction is independent and uses the same source sequences.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>If barcodes have overlapping patterns or are located in overlapping
regions, the extraction order may affect results.</p>
</div>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="trebl_tools.finder.add_umi">
<span class="sig-prename descclassname"><span class="pre">trebl_tools.finder.</span></span><span class="sig-name descname"><span class="pre">add_umi</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">seq_df</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">umi_length</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">12</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/trebl_tools/finder.html#add_umi"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#trebl_tools.finder.add_umi" title="Link to this definition"></a></dt>
<dd><p>Extract UMI (Unique Molecular Identifier) from the end of sequences.</p>
<p>Extracts the last <cite>umi_length</cite> bases from each sequence as the UMI.
This is typically used when UMIs are located at the 3’ end of reads
after barcode regions.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>seq_df</strong> (<em>pd.DataFrame</em><em> or </em><em>dask.DataFrame</em>) – DataFrame containing a ‘sequence’ column
with DNA sequences.</p></li>
<li><p><strong>umi_length</strong> (<em>int</em><em>, </em><em>optional</em>) – Number of bases to extract from sequence end
as the UMI. Defaults to 12.</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p><dl class="simple">
<dt>Updated DataFrame with new ‘UMI’ column</dt><dd><p>containing the extracted UMI sequences.</p>
</dd>
</dl>
</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>pd.DataFrame or dask.DataFrame</p>
</dd>
</dl>
<p class="rubric">Example</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;sequence&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;ATCGATCGATCGATCG&quot;</span><span class="p">,</span> <span class="s2">&quot;GCTAGCTAGCTAGCTA&quot;</span><span class="p">]})</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">result_df</span> <span class="o">=</span> <span class="n">add_umi</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">umi_length</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">result_df</span><span class="p">)</span>
<span class="go">           sequence   UMI</span>
<span class="go">0  ATCGATCGATCGATCG  ATCG</span>
<span class="go">1  GCTAGCTAGCTAGCTA  GCTA</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Currently hardcoded to extract the last 12 bases regardless of the
umi_length parameter. This appears to be a bug that should be fixed
to use the umi_length parameter.</p>
</div>
<div class="admonition-todo admonition" id="id1">
<p class="admonition-title">Todo</p>
<p>Fix implementation to use umi_length parameter instead of hardcoded -12.</p>
</div>
</dd></dl>

</section>
<section id="module-trebl_tools.initial_map">
<span id="trebl-tools-initial-map-module"></span><h2>trebl_tools.initial_map module<a class="headerlink" href="#module-trebl_tools.initial_map" title="Link to this heading"></a></h2>
<dl class="py class">
<dt class="sig sig-object py" id="trebl_tools.initial_map.InitialMapper">
<span class="property"><span class="k"><span class="pre">class</span></span><span class="w"> </span></span><span class="sig-prename descclassname"><span class="pre">trebl_tools.initial_map.</span></span><span class="sig-name descname"><span class="pre">InitialMapper</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">db_path</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">seq_file</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">bc_objects</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">step_name</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">reverse_complement</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">design_file_path</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">umi_object</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/trebl_tools/initial_map.html#InitialMapper"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#trebl_tools.initial_map.InitialMapper" title="Link to this definition"></a></dt>
<dd><p>Bases: <code class="xref py py-class docutils literal notranslate"><span class="pre">object</span></code></p>
<p>Extract and map barcodes from DNA sequences in FASTQ or TXT files.</p>
<p>This class reads sequence files, optionally reverse-complements them,
extracts barcodes and UMIs based on specified patterns, and merges with
a design file to produce an initial mapping table stored in DuckDB.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>db_path</strong> (<em>str</em>) – Path to DuckDB database file where tables will be created.</p></li>
<li><p><strong>seq_file</strong> (<em>str</em><em> or </em><em>list</em><em>[</em><em>str</em><em>]</em>) – Path(s) to input FASTQ or sequence files.
Supports both single files and lists of multiple files.</p></li>
<li><p><strong>bc_objects</strong> (<em>list</em>) – List of barcode objects, each with attributes:
- name (str): Column name for the barcode
- preceder (str): Sequence pattern before the barcode
- post (str): Sequence pattern after the barcode
- length (int): Expected barcode length</p></li>
<li><p><strong>step_name</strong> (<em>str</em>) – Identifier used as prefix for database table names.</p></li>
<li><p><strong>reverse_complement</strong> (<em>bool</em>) – Whether to reverse complement sequences before mapping.</p></li>
<li><p><strong>design_file_path</strong> (<em>str</em><em>, </em><em>optional</em>) – Path to CSV file containing designed sequences
for validation. Expected to have sequences in first column.</p></li>
<li><p><strong>umi_object</strong> (<em>object</em><em>, </em><em>optional</em>) – UMI extraction object with same attributes
as barcode objects. Defaults to None.</p></li>
</ul>
</dd>
</dl>
<p class="rubric">Example</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Define barcode objects</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ad_bc</span> <span class="o">=</span> <span class="n">BarcodeObject</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;AD_BC&quot;</span><span class="p">,</span> <span class="n">preceder</span><span class="o">=</span><span class="s2">&quot;ATCG&quot;</span><span class="p">,</span> <span class="n">post</span><span class="o">=</span><span class="s2">&quot;GCTA&quot;</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">rep_bc</span> <span class="o">=</span> <span class="n">BarcodeObject</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;REP_BC&quot;</span><span class="p">,</span> <span class="n">preceder</span><span class="o">=</span><span class="s2">&quot;TTAA&quot;</span><span class="p">,</span> <span class="n">post</span><span class="o">=</span><span class="s2">&quot;GGCC&quot;</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># Create mapper</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">mapper</span> <span class="o">=</span> <span class="n">InitialMapper</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">db_path</span><span class="o">=</span><span class="s2">&quot;experiment.duckdb&quot;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">seq_file</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;sample1.fastq.gz&quot;</span><span class="p">,</span> <span class="s2">&quot;sample2.fastq.gz&quot;</span><span class="p">],</span>
<span class="gp">... </span>    <span class="n">bc_objects</span><span class="o">=</span><span class="p">[</span><span class="n">ad_bc</span><span class="p">,</span> <span class="n">rep_bc</span><span class="p">],</span>
<span class="gp">... </span>    <span class="n">step_name</span><span class="o">=</span><span class="s2">&quot;step1&quot;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">reverse_complement</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">design_file_path</span><span class="o">=</span><span class="s2">&quot;designed_sequences.csv&quot;</span>
<span class="gp">... </span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># Run full mapping pipeline</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">mapper</span><span class="o">.</span><span class="n">create_map</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># Preview results</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">preview_df</span> <span class="o">=</span> <span class="n">mapper</span><span class="o">.</span><span class="n">preview_map</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">preview_df</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>For FASTQ files, only sequence lines (every 4th line starting from line 2)
are extracted. Quality flags are automatically generated for each extracted
barcode based on expected length matching.</p>
</div>
<dl class="py method">
<dt class="sig sig-object py" id="trebl_tools.initial_map.InitialMapper.__init__">
<span class="sig-name descname"><span class="pre">__init__</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">db_path</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">seq_file</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">bc_objects</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">step_name</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">reverse_complement</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">design_file_path</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">umi_object</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/trebl_tools/initial_map.html#InitialMapper.__init__"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#trebl_tools.initial_map.InitialMapper.__init__" title="Link to this definition"></a></dt>
<dd><p>Initialize the InitialMapper object and set up DuckDB connection.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>db_path</strong> (<em>str</em>) – Path to DuckDB database file.</p></li>
<li><p><strong>seq_file</strong> (<em>str</em><em> or </em><em>list</em><em>[</em><em>str</em><em>]</em>) – Input sequence file path(s).</p></li>
<li><p><strong>bc_objects</strong> (<em>list</em>) – List of barcode extraction objects.</p></li>
<li><p><strong>step_name</strong> (<em>str</em>) – Step identifier for table naming.</p></li>
<li><p><strong>reverse_complement</strong> (<em>bool</em>) – Whether to reverse complement sequences.</p></li>
<li><p><strong>design_file_path</strong> (<em>str</em>) – Path to design validation file.</p></li>
<li><p><strong>umi_object</strong> (<em>object</em><em>, </em><em>optional</em>) – UMI extraction object.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="trebl_tools.initial_map.InitialMapper.create_map">
<span class="sig-name descname"><span class="pre">create_map</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="_modules/trebl_tools/initial_map.html#InitialMapper.create_map"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#trebl_tools.initial_map.InitialMapper.create_map" title="Link to this definition"></a></dt>
<dd><p>Run the full mapping pipeline on all reads.</p>
<p>Executes the complete barcode extraction pipeline on all sequences
in the input files. Skips processing if the initial mapping table
already exists in the database.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Creates table with name pattern: {step_name}_{barcode_cols}_initial
Resets test_n_reads to None to ensure all reads are processed.
All pipeline steps are automatically timed and logged.</p>
</div>
<p class="rubric">Example</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">mapper</span><span class="o">.</span><span class="n">create_map</span><span class="p">()</span>
<span class="go">✓ Initial map already exists: step1_AD_BC_REP_BC_initial — skipping</span>
</pre></div>
</div>
<p># Or if table doesn’t exist:
Reading 1 FASTQ/TXT file(s)…
Done in 30.45 seconds.
…
Mapping complete.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="trebl_tools.initial_map.InitialMapper.create_test_map">
<span class="sig-name descname"><span class="pre">create_test_map</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">test_n_reads</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">int</span></span><span class="w"> </span><span class="o"><span class="pre">=</span></span><span class="w"> </span><span class="default_value"><span class="pre">100</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/trebl_tools/initial_map.html#InitialMapper.create_test_map"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#trebl_tools.initial_map.InitialMapper.create_test_map" title="Link to this definition"></a></dt>
<dd><p>Run the mapping pipeline on a limited number of reads for testing.</p>
<p>Executes the barcode extraction pipeline on a subset of sequences
for rapid testing and validation. Skips if initial mapping table
already exists.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>test_n_reads</strong> (<em>int</em><em>, </em><em>optional</em>) – Maximum number of reads to process
for testing. Defaults to 100.</p>
</dd>
</dl>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Useful for validating extraction patterns and pipeline functionality
before processing large datasets. Resets test limit after completion.</p>
</div>
<p class="rubric">Example</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">mapper</span><span class="o">.</span><span class="n">create_test_map</span><span class="p">(</span><span class="n">test_n_reads</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>
<span class="go">Reading 1 FASTQ/TXT file(s)...</span>
<span class="go">Done in 2.15 seconds.</span>
<span class="go">...</span>
<span class="go">Mapping complete.</span>
</pre></div>
</div>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="trebl_tools.initial_map.InitialMapper.extract_barcodes">
<span class="sig-name descname"><span class="pre">extract_barcodes</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="_modules/trebl_tools/initial_map.html#InitialMapper.extract_barcodes"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#trebl_tools.initial_map.InitialMapper.extract_barcodes" title="Link to this definition"></a></dt>
<dd><p>Extract all barcode sequences and compute their quality flags.</p>
<p>Processes each barcode object in self.bc_objects to extract the
corresponding barcode sequences from the ‘seq’ table. Creates
both the barcode columns and their associated quality flag columns.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Calls _extract_sequence_object() for each barcode. Quality flags
are boolean columns indicating whether the extracted sequence
matches the expected length.</p>
</div>
<p class="rubric">Example</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">mapper</span><span class="o">.</span><span class="n">extract_barcodes</span><span class="p">()</span>
<span class="go">Extracting 3 barcodes...</span>
<span class="go">AD_BC: extracting between &#39;ATCG&#39; and &#39;GCTA&#39;</span>
<span class="go">RT_BC: extracting 15 bases after preceder &#39;TTAA&#39;</span>
<span class="go">UMI: extracting last 12 bases</span>
<span class="go">Done in 45.67 seconds.</span>
</pre></div>
</div>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="trebl_tools.initial_map.InitialMapper.extract_umi">
<span class="sig-name descname"><span class="pre">extract_umi</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="_modules/trebl_tools/initial_map.html#InitialMapper.extract_umi"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#trebl_tools.initial_map.InitialMapper.extract_umi" title="Link to this definition"></a></dt>
<dd><p>Extract the UMI sequence and compute its quality flag.</p>
<p>Processes the UMI object (if provided) to extract UMI sequences
from the ‘seq’ table using the same pattern-matching approach
as barcode extraction.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Only runs if self.umi_object is not None. Creates both UMI
column and UMI quality flag column.</p>
</div>
<p class="rubric">Example</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">mapper</span><span class="o">.</span><span class="n">extract_umi</span><span class="p">()</span>
<span class="go">Extracting UMI...</span>
<span class="go">UMI: extracting 12 bases after preceder &#39;AAAA&#39;</span>
<span class="go">Done in 12.34 seconds.</span>
</pre></div>
</div>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="trebl_tools.initial_map.InitialMapper.merge_design">
<span class="sig-name descname"><span class="pre">merge_design</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="_modules/trebl_tools/initial_map.html#InitialMapper.merge_design"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#trebl_tools.initial_map.InitialMapper.merge_design" title="Link to this definition"></a></dt>
<dd><p>Merge with design file and create final mapping table.</p>
<p>Merges extracted barcode data with the design file (if provided) to
create a ‘Designed’ column indicating whether sequences match the
designed library. Creates the final initial mapping table and removes
the raw sequence column to save space.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If design_file_path is provided and “AD” column exists, performs
LEFT JOIN with design file. Otherwise, sets all sequences as designed (1).
Creates final table with name pattern: {table_prefix}initial</p>
</div>
<p class="rubric">Example</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">mapper</span><span class="o">.</span><span class="n">merge_design</span><span class="p">()</span>
<span class="go">Merging with design file...</span>
<span class="go">Done in 5.43 seconds.</span>
</pre></div>
</div>
<dl class="field-list simple">
<dt class="field-odd">Raises<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>FileNotFoundError</strong> – If design_file_path is specified but file doesn’t exist.</p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="trebl_tools.initial_map.InitialMapper.preview_map">
<span class="sig-name descname"><span class="pre">preview_map</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="_modules/trebl_tools/initial_map.html#InitialMapper.preview_map"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#trebl_tools.initial_map.InitialMapper.preview_map" title="Link to this definition"></a></dt>
<dd><p>Preview the first 5 rows of the created mapping table.</p>
<p>Returns a sample of the initial mapping table to verify extraction
results and inspect data quality before downstream processing.</p>
<dl class="field-list simple">
<dt class="field-odd">Returns<span class="colon">:</span></dt>
<dd class="field-odd"><p><dl class="simple">
<dt>DataFrame containing the first 5 rows of the initial</dt><dd><p>mapping table with all extracted barcodes, UMI (if applicable),
quality flags, and design validation results.</p>
</dd>
</dl>
</p>
</dd>
<dt class="field-even">Return type<span class="colon">:</span></dt>
<dd class="field-even"><p>pd.DataFrame</p>
</dd>
</dl>
<p class="rubric">Example</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">preview_df</span> <span class="o">=</span> <span class="n">mapper</span><span class="o">.</span><span class="n">preview_map</span><span class="p">()</span>
<span class="go">step1_AD_BC_REP_BC_initial</span>
<span class="go">Total rows: 1500000</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">preview_df</span><span class="p">)</span>
<span class="go">   AD_BC  AD_BC_qual  REP_BC  REP_BC_qual  UMI  UMI_qual  Designed</span>
<span class="go">0  ATCG...    True      TTAA...     True      ...    True         1</span>
<span class="go">1  GCTA...    False     GGCC...     True      ...    True         0</span>
<span class="go">...</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Also prints the table name and total row count for quick reference.
Requires that create_map() or create_test_map() has been run first.</p>
</div>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="trebl_tools.initial_map.InitialMapper.read_fastq">
<span class="sig-name descname"><span class="pre">read_fastq</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="_modules/trebl_tools/initial_map.html#InitialMapper.read_fastq"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#trebl_tools.initial_map.InitialMapper.read_fastq" title="Link to this definition"></a></dt>
<dd><p>Read sequences from FASTQ/TXT files and create an initial sequence table.</p>
<p>Processes input files to extract sequence data. For FASTQ files, extracts
only the sequence lines (every 4th line starting from line 2). Creates
a ‘seq’ table in the connected DuckDB database with all sequences.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If <cite>self.test_n_reads</cite> is set, limits the number of reads processed
for testing purposes.</p>
</div>
<p class="rubric">Example</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">mapper</span><span class="o">.</span><span class="n">test_n_reads</span> <span class="o">=</span> <span class="mi">1000</span>  <span class="c1"># Optional: limit for testing</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">mapper</span><span class="o">.</span><span class="n">read_fastq</span><span class="p">()</span>
<span class="go">Reading 2 FASTQ/TXT file(s)...</span>
<span class="go">Done in 15.34 seconds.</span>
</pre></div>
</div>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="trebl_tools.initial_map.InitialMapper.reverse_complement_fastq">
<span class="sig-name descname"><span class="pre">reverse_complement_fastq</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="_modules/trebl_tools/initial_map.html#InitialMapper.reverse_complement_fastq"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#trebl_tools.initial_map.InitialMapper.reverse_complement_fastq" title="Link to this definition"></a></dt>
<dd><p>Replace sequence column with reverse complement of DNA sequences.</p>
<p>Converts all sequences in the ‘seq’ table to their reverse complement
using DuckDB’s built-in string functions. Only processes sequences if
self.reverse_complement is True.</p>
<p class="rubric">Example</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">mapper</span><span class="o">.</span><span class="n">reverse_complement</span> <span class="o">=</span> <span class="kc">True</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">mapper</span><span class="o">.</span><span class="n">reverse_complement_fastq</span><span class="p">()</span>
<span class="go">Reverse complement of sequences...</span>
<span class="go">Done in 8.21 seconds.</span>
</pre></div>
</div>
</dd></dl>

</dd></dl>

</section>
<section id="module-trebl_tools.map_refiner">
<span id="trebl-tools-map-refiner-module"></span><h2>trebl_tools.map_refiner module<a class="headerlink" href="#module-trebl_tools.map_refiner" title="Link to this heading"></a></h2>
<dl class="py class">
<dt class="sig sig-object py" id="trebl_tools.map_refiner.MapRefiner">
<span class="property"><span class="k"><span class="pre">class</span></span><span class="w"> </span></span><span class="sig-prename descclassname"><span class="pre">trebl_tools.map_refiner.</span></span><span class="sig-name descname"><span class="pre">MapRefiner</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">db_path</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">bc_objects</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">column_pairs</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">reads_threshold</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">map_order</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">step_name</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">''</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">descriptor</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">''</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">design_file</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">output_figures_path</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">min_fraction_major_target</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">0.9</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">manual_ec_threshold</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">True</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">umi_object</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/trebl_tools/map_refiner.html#MapRefiner"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#trebl_tools.map_refiner.MapRefiner" title="Link to this definition"></a></dt>
<dd><p>Bases: <code class="xref py py-class docutils literal notranslate"><span class="pre">object</span></code></p>
<p>Refine and filter sequencing maps generated by InitialMapper.</p>
<p>This class provides a flexible pipeline for processing barcode mapping tables
through multiple sequential filtering steps including quality control, error
correction, read count thresholding, and target uniqueness filtering.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>db_path</strong> (<em>str</em>) – Path to the DuckDB database containing mapping tables.</p></li>
<li><p><strong>bc_objects</strong> (<em>list</em><em>[</em><a class="reference internal" href="#trebl_tools.finder.Barcode" title="trebl_tools.finder.Barcode"><em>Barcode</em></a><em>]</em>) – List of barcode objects with extraction parameters.</p></li>
<li><p><strong>column_pairs</strong> (<em>list</em><em>[</em><em>tuple</em><em>]</em>) – List of (key_columns, target_columns) tuples
for unique target filtering. Each element can be a string or list of strings.</p></li>
<li><p><strong>reads_threshold</strong> (<em>int</em>) – Minimum read count threshold for filtering.</p></li>
<li><p><strong>map_order</strong> (<em>list</em><em>[</em><em>str</em><em>]</em><em>, </em><em>optional</em>) – Custom order of processing steps. If None,
prompts user to select from default steps. Defaults to None.</p></li>
<li><p><strong>step_name</strong> (<em>str</em><em>, </em><em>optional</em>) – Identifier for this processing step. Defaults to “”.</p></li>
<li><p><strong>descriptor</strong> (<em>str</em><em>, </em><em>optional</em>) – Additional descriptor for table naming. Defaults to “”.</p></li>
<li><p><strong>design_file</strong> (<em>str</em><em>, </em><em>optional</em>) – Path to design file for validation. Defaults to None.</p></li>
<li><p><strong>output_figures_path</strong> (<em>str</em><em>, </em><em>optional</em>) – Directory for saving plots and outputs.
Defaults to None.</p></li>
<li><p><strong>min_fraction_major_target</strong> (<em>float</em><em>, </em><em>optional</em>) – Minimum fraction of reads that
must come from the most abundant target. Defaults to 0.9.</p></li>
<li><p><strong>manual_ec_threshold</strong> (<em>bool</em><em>, </em><em>optional</em>) – Whether to manually set error correction
threshold instead of automatic detection. Defaults to True.</p></li>
<li><p><strong>umi_object</strong> (<em>object</em><em>, </em><em>optional</em>) – UMI extraction object. Defaults to None.</p></li>
</ul>
</dd>
</dl>
<p class="rubric">Example</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Define barcode objects and column pairs</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ad_bc</span> <span class="o">=</span> <span class="n">Barcode</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;AD_BC&quot;</span><span class="p">,</span> <span class="n">preceder</span><span class="o">=</span><span class="s2">&quot;ATCG&quot;</span><span class="p">,</span> <span class="n">post</span><span class="o">=</span><span class="s2">&quot;GCTA&quot;</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">rep_bc</span> <span class="o">=</span> <span class="n">Barcode</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;REP_BC&quot;</span><span class="p">,</span> <span class="n">preceder</span><span class="o">=</span><span class="s2">&quot;TTAA&quot;</span><span class="p">,</span> <span class="n">post</span><span class="o">=</span><span class="s2">&quot;GGCC&quot;</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">pairs</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;AD_BC&quot;</span><span class="p">,</span> <span class="s2">&quot;REP_BC&quot;</span><span class="p">),</span> <span class="p">([</span><span class="s2">&quot;AD_BC&quot;</span><span class="p">,</span> <span class="s2">&quot;REP_BC&quot;</span><span class="p">],</span> <span class="s2">&quot;target&quot;</span><span class="p">)]</span>
<span class="gp">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># Create refiner with custom processing order</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">refiner</span> <span class="o">=</span> <span class="n">MapRefiner</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">db_path</span><span class="o">=</span><span class="s2">&quot;experiment.duckdb&quot;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">bc_objects</span><span class="o">=</span><span class="p">[</span><span class="n">ad_bc</span><span class="p">,</span> <span class="n">rep_bc</span><span class="p">],</span>
<span class="gp">... </span>    <span class="n">column_pairs</span><span class="o">=</span><span class="n">pairs</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">reads_threshold</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">map_order</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;quality&quot;</span><span class="p">,</span> <span class="s2">&quot;designed&quot;</span><span class="p">,</span> <span class="s2">&quot;grouped&quot;</span><span class="p">,</span> <span class="s2">&quot;thresholded&quot;</span><span class="p">],</span>
<span class="gp">... </span>    <span class="n">step_name</span><span class="o">=</span><span class="s2">&quot;step2&quot;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">output_figures_path</span><span class="o">=</span><span class="s2">&quot;results/&quot;</span>
<span class="gp">... </span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># Execute refinement pipeline</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">refiner</span><span class="o">.</span><span class="n">refine_map_from_db</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># Generate loss summary</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">loss_df</span> <span class="o">=</span> <span class="n">refiner</span><span class="o">.</span><span class="n">save_loss_table</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">refiner</span><span class="o">.</span><span class="n">plot_loss</span><span class="p">()</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Processing steps are applied sequentially. Each step creates a new table
based on the previous step’s output. Table names follow the pattern:
{step_name}_{barcode_names}_{descriptor}_{step_suffix}</p>
</div>
<dl class="py attribute">
<dt class="sig sig-object py" id="trebl_tools.map_refiner.MapRefiner.DEFAULT_MAP_ORDER">
<span class="sig-name descname"><span class="pre">DEFAULT_MAP_ORDER</span></span><span class="property"><span class="w"> </span><span class="p"><span class="pre">=</span></span><span class="w"> </span><span class="pre">['initial',</span> <span class="pre">'quality',</span> <span class="pre">'error_corrected',</span> <span class="pre">'grouped',</span> <span class="pre">'thresholded',</span> <span class="pre">'barcode_exists',</span> <span class="pre">'unique_target',</span> <span class="pre">'designed']</span></span><a class="headerlink" href="#trebl_tools.map_refiner.MapRefiner.DEFAULT_MAP_ORDER" title="Link to this definition"></a></dt>
<dd></dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="trebl_tools.map_refiner.MapRefiner.__init__">
<span class="sig-name descname"><span class="pre">__init__</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">db_path</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">bc_objects</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">column_pairs</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">reads_threshold</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">map_order</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">step_name</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">''</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">descriptor</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">''</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">design_file</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">output_figures_path</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">min_fraction_major_target</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">0.9</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">manual_ec_threshold</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">True</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">umi_object</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/trebl_tools/map_refiner.html#MapRefiner.__init__"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#trebl_tools.map_refiner.MapRefiner.__init__" title="Link to this definition"></a></dt>
<dd><p>Initialize MapRefiner with processing parameters and database connection.</p>
<p>Sets up database connection, configures table naming, and prompts user
for processing step order if not provided.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>db_path</strong> (<em>str</em>) – Path to DuckDB database.</p></li>
<li><p><strong>bc_objects</strong> (<em>list</em>) – Barcode objects for processing.</p></li>
<li><p><strong>column_pairs</strong> (<em>list</em>) – Key-target column pairs for filtering.</p></li>
<li><p><strong>reads_threshold</strong> (<em>int</em>) – Minimum read count threshold.</p></li>
<li><p><strong>map_order</strong> (<em>list</em><em>, </em><em>optional</em>) – Custom processing step order.</p></li>
<li><p><strong>step_name</strong> (<em>str</em>) – Processing step identifier.</p></li>
<li><p><strong>descriptor</strong> (<em>str</em>) – Additional table name descriptor.</p></li>
<li><p><strong>design_file</strong> (<em>str</em><em>, </em><em>optional</em>) – Path to validation design file.</p></li>
<li><p><strong>output_figures_path</strong> (<em>str</em><em>, </em><em>optional</em>) – Output directory for plots.</p></li>
<li><p><strong>min_fraction_major_target</strong> (<em>float</em>) – Fraction threshold for target filtering.</p></li>
<li><p><strong>manual_ec_threshold</strong> (<em>bool</em>) – Use manual error correction threshold.</p></li>
<li><p><strong>umi_object</strong> (<em>object</em><em>, </em><em>optional</em>) – UMI extraction object.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="trebl_tools.map_refiner.MapRefiner.apply_whitelist">
<span class="sig-name descname"><span class="pre">apply_whitelist</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">output_dir</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">prev_table</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/trebl_tools/map_refiner.html#MapRefiner.apply_whitelist"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#trebl_tools.map_refiner.MapRefiner.apply_whitelist" title="Link to this definition"></a></dt>
<dd><p>Apply UMI-tools whitelist error correction to barcode sequences.</p>
<p>Generates FASTQ from barcode sequences, runs UMI-tools whitelist to identify
canonical sequences, and updates the database with error-corrected barcodes.
Recalculates quality flags and design validation after correction.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>output_dir</strong> (<em>str</em><em> or </em><em>Path</em>) – Directory for temporary files and whitelist outputs.</p></li>
<li><p><strong>prev_table</strong> (<em>str</em><em>, </em><em>optional</em>) – Name of the previous table to correct.</p></li>
</ul>
</dd>
</dl>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Either uses manual threshold (prompts user) or automatic detection for
expected barcode count. Updates barcode sequences in-place with canonical
forms. Removes temporary FASTQ file after processing.</p>
</div>
<p class="rubric">Example</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">refiner</span><span class="o">.</span><span class="n">apply_whitelist</span><span class="p">(</span><span class="s2">&quot;error_correction/&quot;</span><span class="p">,</span> <span class="n">prev_table</span><span class="o">=</span><span class="s2">&quot;quality&quot;</span><span class="p">)</span>
<span class="go">=== Applying whitelist for step1 ===</span>
<span class="go">Generating FASTQ: error_correction/step1_AD_BC_filtered_barcodes_extracted.fastq</span>
<span class="go">Running umi_tools whitelist...</span>
<span class="go">Unique canonical barcodes: 1500</span>
<span class="go">Whitelist application complete for step1 at step1_AD_BC_error_corrected</span>
</pre></div>
</div>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="trebl_tools.map_refiner.MapRefiner.barcode_exists">
<span class="sig-name descname"><span class="pre">barcode_exists</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">previous_table</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'initial'</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/trebl_tools/map_refiner.html#MapRefiner.barcode_exists"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#trebl_tools.map_refiner.MapRefiner.barcode_exists" title="Link to this definition"></a></dt>
<dd><p>Remove rows with null or empty barcode sequences.</p>
<p>Filters out rows where any barcode column (except AD) is NULL or
contains only whitespace, ensuring all required barcodes are present.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>previous_table</strong> (<em>str</em><em>, </em><em>optional</em>) – Name of the previous table to filter.
Defaults to “initial”.</p>
</dd>
</dl>
<p class="rubric">Example</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">refiner</span><span class="o">.</span><span class="n">barcode_exists</span><span class="p">(</span><span class="s2">&quot;initial&quot;</span><span class="p">)</span>
<span class="go">Removing rows with null or empty barcodes (excluding AD)...</span>
<span class="go">Done in 15.23 seconds.</span>
</pre></div>
</div>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="trebl_tools.map_refiner.MapRefiner.check_exists">
<span class="sig-name descname"><span class="pre">check_exists</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">check_table_name</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/trebl_tools/map_refiner.html#MapRefiner.check_exists"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#trebl_tools.map_refiner.MapRefiner.check_exists" title="Link to this definition"></a></dt>
<dd><p>Check if a table exists and determine if processing should be skipped.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>check_table_name</strong> (<em>str</em>) – Full table name to check for existence.</p>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>True if table exists and processing should be skipped, False otherwise.</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>bool</p>
</dd>
</dl>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Only skips for initial, grouped, or loss tables to avoid overwriting
important base tables. Controlled by should_check_exists attribute.</p>
</div>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="trebl_tools.map_refiner.MapRefiner.close_connection">
<span class="sig-name descname"><span class="pre">close_connection</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="_modules/trebl_tools/map_refiner.html#MapRefiner.close_connection"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#trebl_tools.map_refiner.MapRefiner.close_connection" title="Link to this definition"></a></dt>
<dd><p>Close the DuckDB database connection.</p>
<p>Properly closes the database connection and sets it to None to prevent
further operations on a closed connection.</p>
<p class="rubric">Example</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">refiner</span><span class="o">.</span><span class="n">close_connection</span><span class="p">()</span>
</pre></div>
</div>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="trebl_tools.map_refiner.MapRefiner.create_designed">
<span class="sig-name descname"><span class="pre">create_designed</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">previous_table</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'quality'</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/trebl_tools/map_refiner.html#MapRefiner.create_designed"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#trebl_tools.map_refiner.MapRefiner.create_designed" title="Link to this definition"></a></dt>
<dd><p>Filter to designed sequences only.</p>
<p>Keeps only rows where the Designed column equals 1, indicating that
the barcode combination matches the designed library.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>previous_table</strong> (<em>str</em><em>, </em><em>optional</em>) – Name of the previous table to filter.
Defaults to “quality”.</p>
</dd>
</dl>
<p class="rubric">Example</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">refiner</span><span class="o">.</span><span class="n">create_designed</span><span class="p">(</span><span class="s2">&quot;quality&quot;</span><span class="p">)</span>
<span class="go">Filtering to designed sequences...</span>
<span class="go">Created table: step1_AD_BC_REP_BC_designed — kept only Designed == 1.</span>
<span class="go">Done in 8.67 seconds.</span>
</pre></div>
</div>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="trebl_tools.map_refiner.MapRefiner.create_error_corrected">
<span class="sig-name descname"><span class="pre">create_error_corrected</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">previous_table</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'quality'</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/trebl_tools/map_refiner.html#MapRefiner.create_error_corrected"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#trebl_tools.map_refiner.MapRefiner.create_error_corrected" title="Link to this definition"></a></dt>
<dd><p>Perform error correction using UMI-tools whitelist approach.</p>
<p>Executes the complete error correction pipeline: generates FASTQ from
barcode sequences, applies UMI-tools whitelist algorithm, and updates
the database with canonical (error-corrected) barcode sequences.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>previous_table</strong> (<em>str</em><em>, </em><em>optional</em>) – Name of the previous table to correct.
Defaults to “quality”.</p>
</dd>
</dl>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Creates output directory for intermediate files if not exists.
All temporary files are cleaned up automatically.</p>
</div>
<p class="rubric">Example</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">refiner</span><span class="o">.</span><span class="n">create_error_corrected</span><span class="p">(</span><span class="s2">&quot;quality&quot;</span><span class="p">)</span>
<span class="go">=== Running error correction step on step1_AD_BC_quality ===</span>
<span class="go">Generating FASTQ: error_corrected/step1_AD_BC_filtered_barcodes_extracted.fastq</span>
<span class="go">Running umi_tools whitelist...</span>
<span class="go">Whitelist application complete for step1 at step1_AD_BC_error_corrected</span>
<span class="go">Done in 2.5 minutes.</span>
</pre></div>
</div>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="trebl_tools.map_refiner.MapRefiner.create_grouped">
<span class="sig-name descname"><span class="pre">create_grouped</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">previous_table</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'quality_designed'</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/trebl_tools/map_refiner.html#MapRefiner.create_grouped"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#trebl_tools.map_refiner.MapRefiner.create_grouped" title="Link to this definition"></a></dt>
<dd><p>Group identical barcode combinations and count occurrences.</p>
<p>Aggregates reads by unique barcode combinations, creating a count column
with the number of occurrences for each combination. Optionally generates
a read count distribution histogram.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>previous_table</strong> (<em>str</em><em>, </em><em>optional</em>) – Name of the previous table to group.
Defaults to “quality_designed”.</p>
</dd>
</dl>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Groups by all barcode columns plus quality and design flags.
Generates histogram plot if output_figures_path is specified.</p>
</div>
<p class="rubric">Example</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">refiner</span><span class="o">.</span><span class="n">create_grouped</span><span class="p">(</span><span class="s2">&quot;quality&quot;</span><span class="p">)</span>
<span class="go">Grouping step1_AD_BC_REP_BC_quality...</span>
<span class="go">Done in 45.67 seconds.</span>
</pre></div>
</div>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="trebl_tools.map_refiner.MapRefiner.create_initial">
<span class="sig-name descname"><span class="pre">create_initial</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">parquet_path</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/trebl_tools/map_refiner.html#MapRefiner.create_initial"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#trebl_tools.map_refiner.MapRefiner.create_initial" title="Link to this definition"></a></dt>
<dd><p>Load initial mapping table from Parquet file into database.</p>
<p>Creates the initial mapping table by reading from a Parquet file.
This serves as the starting point for all subsequent processing steps.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>parquet_path</strong> (<em>str</em>) – Path to the Parquet file containing initial mapping data.</p>
</dd>
</dl>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Skips loading if table already exists and check_exists is enabled.</p>
</div>
<p class="rubric">Example</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">refiner</span><span class="o">.</span><span class="n">create_initial</span><span class="p">(</span><span class="s2">&quot;initial_mapping.parquet&quot;</span><span class="p">)</span>
<span class="go">Reading initial map from initial_mapping.parquet as step1_AD_BC_initial...</span>
<span class="go">Done in 5.23 seconds.</span>
</pre></div>
</div>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="trebl_tools.map_refiner.MapRefiner.create_quality">
<span class="sig-name descname"><span class="pre">create_quality</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">previous_table</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'initial'</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/trebl_tools/map_refiner.html#MapRefiner.create_quality"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#trebl_tools.map_refiner.MapRefiner.create_quality" title="Link to this definition"></a></dt>
<dd><p>Filter to high-quality reads based on barcode and UMI quality flags.</p>
<p>Keeps only rows where all barcode quality flags (and UMI quality flag
if present) are TRUE, indicating successful extraction with expected lengths.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>previous_table</strong> (<em>str</em><em>, </em><em>optional</em>) – Name of the previous table to filter.
Defaults to “initial”.</p>
</dd>
</dl>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Automatically includes UMI quality filtering if umi_object is configured.</p>
</div>
<p class="rubric">Example</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">refiner</span><span class="o">.</span><span class="n">create_quality</span><span class="p">(</span><span class="s2">&quot;initial&quot;</span><span class="p">)</span>
<span class="go">Filtering to high-quality reads...</span>
<span class="go">Created table: step1_AD_BC_REP_BC_quality — filtered for TRUE in all *_qual columns.</span>
<span class="go">Done in 12.45 seconds.</span>
</pre></div>
</div>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="trebl_tools.map_refiner.MapRefiner.create_thresholded">
<span class="sig-name descname"><span class="pre">create_thresholded</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">previous_table</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/trebl_tools/map_refiner.html#MapRefiner.create_thresholded"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#trebl_tools.map_refiner.MapRefiner.create_thresholded" title="Link to this definition"></a></dt>
<dd><p>Filter barcode combinations by minimum read count threshold.</p>
<p>Removes barcode combinations with read counts below the specified threshold.
Prompts user for threshold if not already set. Optionally generates a
histogram showing the threshold cutoff.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>previous_table</strong> (<em>str</em>) – Name of the previous table to threshold.</p>
</dd>
</dl>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Uses self.reads_threshold or prompts user for input.
Generates histogram with threshold line if output_figures_path is specified.</p>
</div>
<p class="rubric">Example</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">refiner</span><span class="o">.</span><span class="n">create_thresholded</span><span class="p">(</span><span class="s2">&quot;grouped&quot;</span><span class="p">)</span>
<span class="go">Thresholding...</span>
<span class="go">Using reads threshold of 10.</span>
<span class="go">Done in 8.34 seconds.</span>
</pre></div>
</div>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="trebl_tools.map_refiner.MapRefiner.create_unique_target">
<span class="sig-name descname"><span class="pre">create_unique_target</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">previous_table</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/trebl_tools/map_refiner.html#MapRefiner.create_unique_target"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#trebl_tools.map_refiner.MapRefiner.create_unique_target" title="Link to this definition"></a></dt>
<dd><p>Filter for unique target relationships using configurable column pairs.</p>
<p>For each (key_columns, target_columns) pair, keeps only keys where the
most abundant target accounts for at least min_fraction_major_target
of reads. This ensures that each key maps predominantly to a single target.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>previous_table</strong> (<em>str</em>) – Name of the previous table to filter.</p>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>Name of the created filtered table.</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>str</p>
</dd>
</dl>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Processes each column pair independently then intersects results.
Uses self.min_fraction_major_target as the threshold (default 0.9).
Cleans up intermediate tables automatically.</p>
</div>
<p class="rubric">Example</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="c1"># With column_pairs = [(&quot;AD_BC&quot;, &quot;REP_BC&quot;), ([&quot;AD_BC&quot;, &quot;REP_BC&quot;], &quot;target&quot;)]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">filtered_table</span> <span class="o">=</span> <span class="n">refiner</span><span class="o">.</span><span class="n">create_unique_target</span><span class="p">(</span><span class="s2">&quot;thresholded&quot;</span><span class="p">)</span>
<span class="go">Filtering so that at least 90% of reads come from the most abundant target...</span>
<span class="go">Processing mapping 1: AD_BC → REP_BC</span>
<span class="go">Processing mapping 2: AD_BC || &#39;-&#39; || REP_BC → target</span>
<span class="go">Created filtered table: step1_AD_BC_REP_BC_unique_target</span>
<span class="go">Done in 15.67 seconds.</span>
</pre></div>
</div>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="trebl_tools.map_refiner.MapRefiner.generate_fastq_for_whitelist">
<span class="sig-name descname"><span class="pre">generate_fastq_for_whitelist</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">output_dir</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">suffix</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'_barcodes_extracted.fastq'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">prev_table</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'quality'</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/trebl_tools/map_refiner.html#MapRefiner.generate_fastq_for_whitelist"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#trebl_tools.map_refiner.MapRefiner.generate_fastq_for_whitelist" title="Link to this definition"></a></dt>
<dd><p>Generate synthetic FASTQ file from filtered barcode sequences for error correction.</p>
<p>Creates a FASTQ file containing concatenated barcode sequences for input
to UMI-tools whitelist error correction. Only includes reads that pass
all quality checks.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>output_dir</strong> (<em>str</em><em> or </em><em>Path</em><em>, </em><em>optional</em>) – Directory to save FASTQ.
Defaults to current directory.</p></li>
<li><p><strong>suffix</strong> (<em>str</em><em>, </em><em>optional</em>) – Suffix for FASTQ filename.
Defaults to “_barcodes_extracted.fastq”.</p></li>
<li><p><strong>prev_table</strong> (<em>str</em><em>, </em><em>optional</em>) – Name of the previous table to use.
Defaults to “quality”.</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>Path to the generated FASTQ file.</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>str</p>
</dd>
</dl>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Adds dummy UMI ‘A’ and quality scores ‘I’ for UMI-tools compatibility.
Only includes reads where all barcode quality flags are TRUE.</p>
</div>
<p class="rubric">Example</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">fastq_path</span> <span class="o">=</span> <span class="n">refiner</span><span class="o">.</span><span class="n">generate_fastq_for_whitelist</span><span class="p">(</span><span class="s2">&quot;temp/&quot;</span><span class="p">,</span> <span class="n">prev_table</span><span class="o">=</span><span class="s2">&quot;quality&quot;</span><span class="p">)</span>
<span class="go">Generating FASTQ: temp/step1_AD_BC_filtered_barcodes_extracted.fastq</span>
<span class="go">Wrote 50000 reads to temp/step1_AD_BC_filtered_barcodes_extracted.fastq</span>
<span class="go">Done in 23.45 seconds.</span>
</pre></div>
</div>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="trebl_tools.map_refiner.MapRefiner.get_map_df">
<span class="sig-name descname"><span class="pre">get_map_df</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">map_name</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">insert_prefix</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">True</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/trebl_tools/map_refiner.html#MapRefiner.get_map_df"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#trebl_tools.map_refiner.MapRefiner.get_map_df" title="Link to this definition"></a></dt>
<dd><p>Retrieve a mapping table as a pandas DataFrame.</p>
<p>Loads a table from the database, automatically handling prefixed and
non-prefixed table names.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>map_name</strong> (<em>str</em>) – Base name of the table to retrieve.</p></li>
<li><p><strong>insert_prefix</strong> (<em>bool</em><em>, </em><em>optional</em>) – Whether to try prefixed name first.
Defaults to True.</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>DataFrame containing the requested table data.</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>pd.DataFrame</p>
</dd>
</dl>
<p class="rubric">Example</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">df</span> <span class="o">=</span> <span class="n">refiner</span><span class="o">.</span><span class="n">get_map_df</span><span class="p">(</span><span class="s2">&quot;quality&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Retrieved </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="si">}</span><span class="s2"> rows from quality table&quot;</span><span class="p">)</span>
</pre></div>
</div>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="trebl_tools.map_refiner.MapRefiner.merge_design">
<span class="sig-name descname"><span class="pre">merge_design</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">prev_table</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/trebl_tools/map_refiner.html#MapRefiner.merge_design"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#trebl_tools.map_refiner.MapRefiner.merge_design" title="Link to this definition"></a></dt>
<dd><p>Merge with design file to validate barcode combinations.</p>
<p>Adds or updates the ‘Designed’ column by comparing barcode sequences
against a design file. Sets Designed=1 for sequences that match the
design library, Designed=0 otherwise.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>prev_table</strong> (<em>str</em><em>, </em><em>optional</em>) – Name of the table to update.
Defaults to “seq”.</p>
</dd>
</dl>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If no design file is provided, sets all sequences as designed (Designed=1).
Automatically removes the ‘sequence’ column if present to save space.</p>
</div>
<p class="rubric">Example</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">refiner</span><span class="o">.</span><span class="n">merge_design</span><span class="p">(</span><span class="n">prev_table</span><span class="o">=</span><span class="s2">&quot;error_corrected&quot;</span><span class="p">)</span>
<span class="go">Merging with design file...</span>
<span class="go">Done in 12.34 seconds.</span>
</pre></div>
</div>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="trebl_tools.map_refiner.MapRefiner.plot_all_whitelists_from_summary">
<span class="sig-name descname"><span class="pre">plot_all_whitelists_from_summary</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">summary_df</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">n_cols</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">4</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">dpi</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">300</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/trebl_tools/map_refiner.html#MapRefiner.plot_all_whitelists_from_summary"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#trebl_tools.map_refiner.MapRefiner.plot_all_whitelists_from_summary" title="Link to this definition"></a></dt>
<dd><p>Create multi-panel visualization of error correction summaries.</p>
<p>Generates a comprehensive figure with multiple panels showing error
correction performance metrics using pre-computed summary data.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>summary_df</strong> (<em>pd.DataFrame</em>) – DataFrame with error correction summary data.
Must contain columns: [‘canonical’, ‘num_merged’, ‘largest_count’, ‘rest_count’].</p></li>
<li><p><strong>n_cols</strong> (<em>int</em><em>, </em><em>optional</em>) – Number of panels per row. Defaults to 4.</p></li>
<li><p><strong>dpi</strong> (<em>int</em><em>, </em><em>optional</em>) – Figure resolution in dots per inch. Defaults to 300.</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>Figure object containing all summary panels.</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>matplotlib.figure.Figure</p>
</dd>
</dl>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Delegates to plotting.plot_all_whitelists_from_summary() for implementation.</p>
</div>
<p class="rubric">Example</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">summary_df</span> <span class="o">=</span> <span class="n">refiner</span><span class="o">.</span><span class="n">plot_error_correction</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">fig</span> <span class="o">=</span> <span class="n">refiner</span><span class="o">.</span><span class="n">plot_all_whitelists_from_summary</span><span class="p">(</span><span class="n">summary_df</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;whitelist_analysis.png&quot;</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>
<span class="go">Done in 12.34 seconds.</span>
</pre></div>
</div>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="trebl_tools.map_refiner.MapRefiner.plot_error_correction">
<span class="sig-name descname"><span class="pre">plot_error_correction</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">save_dir</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">plot</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">True</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/trebl_tools/map_refiner.html#MapRefiner.plot_error_correction"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#trebl_tools.map_refiner.MapRefiner.plot_error_correction" title="Link to this definition"></a></dt>
<dd><p>Generate summary plots and analysis of error correction results.</p>
<p>Creates comprehensive visualizations of barcode error correction performance
by reading whitelist files and generating summary statistics and plots.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>save_dir</strong> (<em>str</em><em> or </em><em>Path</em><em>, </em><em>optional</em>) – Directory to save plot outputs.
If None, uses output_figures_path. Defaults to None.</p></li>
<li><p><strong>plot</strong> (<em>bool</em><em>, </em><em>optional</em>) – Whether to generate and save plots.
Defaults to True.</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p><dl class="simple">
<dt>Summary table with error correction statistics including</dt><dd><p>canonical sequences, collapsed sequences, and group sizes.</p>
</dd>
</dl>
</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>pd.DataFrame</p>
</dd>
</dl>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Delegates to plotting.plot_error_correction() for implementation.</p>
</div>
<p class="rubric">Example</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">summary_df</span> <span class="o">=</span> <span class="n">refiner</span><span class="o">.</span><span class="n">plot_error_correction</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error correction reduced </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">summary_df</span><span class="p">)</span><span class="si">}</span><span class="s2"> sequence groups&quot;</span><span class="p">)</span>
<span class="go">Done in 45.23 seconds.</span>
</pre></div>
</div>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="trebl_tools.map_refiner.MapRefiner.plot_loss">
<span class="sig-name descname"><span class="pre">plot_loss</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">ax</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">palette</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'rocket_r'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">text_offset</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">0</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">show_background</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">True</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/trebl_tools/map_refiner.html#MapRefiner.plot_loss"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#trebl_tools.map_refiner.MapRefiner.plot_loss" title="Link to this definition"></a></dt>
<dd><p>Create visualization of processing losses across refinement steps.</p>
<p>Generates a horizontal bar plot showing both total reads and unique counts
at each processing step, with options for background bars and count labels.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>ax</strong> (<em>matplotlib.axes.Axes</em><em>, </em><em>optional</em>) – Existing axis to plot on.
If None, creates new figure. Defaults to None.</p></li>
<li><p><strong>palette</strong> (<em>str</em><em>, </em><em>optional</em>) – Seaborn color palette name. Defaults to “rocket_r”.</p></li>
<li><p><strong>text_offset</strong> (<em>float</em><em>, </em><em>optional</em>) – Vertical offset for count labels.
Defaults to 0.</p></li>
<li><p><strong>show_background</strong> (<em>bool</em><em>, </em><em>optional</em>) – Whether to show background bars for
total reads with reduced opacity. Defaults to True.</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>(fig, ax) matplotlib Figure and Axes objects.</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>tuple</p>
</dd>
</dl>
<p class="rubric">Example</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">refiner</span><span class="o">.</span><span class="n">plot_loss</span><span class="p">(</span><span class="n">palette</span><span class="o">=</span><span class="s2">&quot;viridis&quot;</span><span class="p">,</span> <span class="n">show_background</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Processing Loss Summary&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Automatically calls save_loss_table() to generate summary data.
Saves plot automatically if output_figures_path is configured.</p>
</div>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="trebl_tools.map_refiner.MapRefiner.plot_reads_histogram">
<span class="sig-name descname"><span class="pre">plot_reads_histogram</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">previous_table</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">save_path</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">ax</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">**</span></span><span class="n"><span class="pre">kwargs</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/trebl_tools/map_refiner.html#MapRefiner.plot_reads_histogram"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#trebl_tools.map_refiner.MapRefiner.plot_reads_histogram" title="Link to this definition"></a></dt>
<dd><p>Generate histogram of read count distributions for a processing table.</p>
<p>Creates a log-log scale histogram showing the distribution of read counts
for barcode combinations in the specified table.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>previous_table</strong> (<em>str</em>) – Name of the table to plot.</p></li>
<li><p><strong>save_path</strong> (<em>str</em><em>, </em><em>optional</em>) – Path to save the plot. Defaults to None.</p></li>
<li><p><strong>ax</strong> (<em>matplotlib.axes.Axes</em><em>, </em><em>optional</em>) – Existing axis to plot on.
Defaults to None.</p></li>
<li><p><strong>**kwargs</strong> – Additional arguments passed to the plotting function.</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>Axis object with the histogram.</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>matplotlib.axes.Axes</p>
</dd>
</dl>
<p class="rubric">Example</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">ax</span> <span class="o">=</span> <span class="n">refiner</span><span class="o">.</span><span class="n">plot_reads_histogram</span><span class="p">(</span><span class="s2">&quot;grouped&quot;</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Read Count Distribution&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="trebl_tools.map_refiner.MapRefiner.refine_map_from_db">
<span class="sig-name descname"><span class="pre">refine_map_from_db</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">save_name</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">should_check_exists</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/trebl_tools/map_refiner.html#MapRefiner.refine_map_from_db"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#trebl_tools.map_refiner.MapRefiner.refine_map_from_db" title="Link to this definition"></a></dt>
<dd><p>Execute the complete map refinement pipeline.</p>
<p>Runs all configured processing steps in sequence according to map_order.
Each step creates a new table based on the previous step’s output.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>save_name</strong> (<em>str</em><em>, </em><em>optional</em>) – Name for final output table. If provided,
creates a copy of the final result with this name. Defaults to None.</p></li>
<li><p><strong>should_check_exists</strong> (<em>bool</em><em>, </em><em>optional</em>) – Whether to skip processing if
tables already exist. Defaults to False.</p></li>
</ul>
</dd>
</dl>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Steps are executed in the order specified by self.map_order.
Each processing function receives the previous table name as input.</p>
</div>
<p class="rubric">Example</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">refiner</span><span class="o">.</span><span class="n">refine_map_from_db</span><span class="p">(</span><span class="n">save_name</span><span class="o">=</span><span class="s2">&quot;final_refined_map&quot;</span><span class="p">)</span>
<span class="go"># Executes: initial -&gt; quality -&gt; designed -&gt; grouped -&gt; thresholded</span>
<span class="go">Done.</span>
</pre></div>
</div>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="trebl_tools.map_refiner.MapRefiner.save_loss_table">
<span class="sig-name descname"><span class="pre">save_loss_table</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="_modules/trebl_tools/map_refiner.html#MapRefiner.save_loss_table"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#trebl_tools.map_refiner.MapRefiner.save_loss_table" title="Link to this definition"></a></dt>
<dd><p>Generate and save comprehensive processing loss summary.</p>
<p>Creates a detailed summary table showing read counts, unique sequences,
and percentage losses at each step of the refinement pipeline. Includes
both step-by-step and cumulative loss calculations.</p>
<dl class="field-list simple">
<dt class="field-odd">Returns<span class="colon">:</span></dt>
<dd class="field-odd"><p><dl class="simple">
<dt>Summary DataFrame with columns:</dt><dd><ul class="simple">
<li><p>map (str): Processing step name</p></li>
<li><p>description (str): Human-readable step description</p></li>
<li><p>unique_count (int): Number of unique barcode combinations</p></li>
<li><p>unique_AD_count (int): Number of unique AD sequences</p></li>
<li><p>total_reads (int): Total number of reads (if count column exists)</p></li>
<li><p>% of previous step (float): Percentage retained from previous step</p></li>
<li><p>% of total reads (float): Percentage retained from initial step</p></li>
</ul>
</dd>
</dl>
</p>
</dd>
<dt class="field-even">Return type<span class="colon">:</span></dt>
<dd class="field-even"><p>pd.DataFrame</p>
</dd>
</dl>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Automatically saves CSV file if output_figures_path is configured.
Also creates a database table with the loss summary for further analysis.
Step descriptions are defined in the internal map_info_dict.</p>
</div>
<p class="rubric">Example</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">loss_df</span> <span class="o">=</span> <span class="n">refiner</span><span class="o">.</span><span class="n">save_loss_table</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">loss_df</span><span class="p">)</span>
<span class="go">        map                        description  unique_count  total_reads  % of previous step</span>
<span class="go">0   initial              Initial combinations         10000       100000              100.00</span>
<span class="go">1   quality           After quality filtering          8000        80000               80.00</span>
<span class="go">2  designed           After designed filtering          7500        75000               93.75</span>
<span class="go">3   grouped                    Grouped counts          7500        75000              100.00</span>
<span class="go">4 thresholded  Filtered by # reads &gt; 10              5000        65000               66.67</span>
<span class="go">Saved loss summary table as &#39;step1_AD_BC_REP_BC_strict_loss_summary&#39;</span>
</pre></div>
</div>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="trebl_tools.map_refiner.MapRefiner.save_map">
<span class="sig-name descname"><span class="pre">save_map</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">map_name</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">map_path</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/trebl_tools/map_refiner.html#MapRefiner.save_map"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#trebl_tools.map_refiner.MapRefiner.save_map" title="Link to this definition"></a></dt>
<dd><p>Save a mapping table to CSV file.</p>
<p>Exports a table from the database to a CSV file with headers.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>map_name</strong> (<em>str</em>) – Name of the table to save.</p></li>
<li><p><strong>map_path</strong> (<em>str</em>) – Path where CSV file should be saved.</p></li>
</ul>
</dd>
</dl>
<p class="rubric">Example</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">refiner</span><span class="o">.</span><span class="n">save_map</span><span class="p">(</span><span class="s2">&quot;quality&quot;</span><span class="p">,</span> <span class="s2">&quot;outputs/quality_filtered.csv&quot;</span><span class="p">)</span>
</pre></div>
</div>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="trebl_tools.map_refiner.MapRefiner.show_tables">
<span class="sig-name descname"><span class="pre">show_tables</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="_modules/trebl_tools/map_refiner.html#MapRefiner.show_tables"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#trebl_tools.map_refiner.MapRefiner.show_tables" title="Link to this definition"></a></dt>
<dd><p>Display all tables in the connected DuckDB database.</p>
<dl class="field-list simple">
<dt class="field-odd">Returns<span class="colon">:</span></dt>
<dd class="field-odd"><p>List of tuples containing table names in the database.</p>
</dd>
<dt class="field-even">Return type<span class="colon">:</span></dt>
<dd class="field-even"><p>list</p>
</dd>
</dl>
<p class="rubric">Example</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">tables</span> <span class="o">=</span> <span class="n">refiner</span><span class="o">.</span><span class="n">show_tables</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">tables</span><span class="p">)</span><span class="si">}</span><span class="s2"> tables in database&quot;</span><span class="p">)</span>
</pre></div>
</div>
</dd></dl>

</dd></dl>

</section>
<section id="module-trebl_tools.pipelines">
<span id="trebl-tools-pipelines-module"></span><h2>trebl_tools.pipelines module<a class="headerlink" href="#module-trebl_tools.pipelines" title="Link to this heading"></a></h2>
<dl class="py class">
<dt class="sig sig-object py" id="trebl_tools.pipelines.TreblPipeline">
<span class="property"><span class="k"><span class="pre">class</span></span><span class="w"> </span></span><span class="sig-prename descclassname"><span class="pre">trebl_tools.pipelines.</span></span><span class="sig-name descname"><span class="pre">TreblPipeline</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">db_path</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">design_file_path</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">error_correction</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">output_path</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">test_n_reads</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/trebl_tools/pipelines.html#TreblPipeline"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#trebl_tools.pipelines.TreblPipeline" title="Link to this definition"></a></dt>
<dd><p>Bases: <code class="xref py py-class docutils literal notranslate"><span class="pre">object</span></code></p>
<p>End-to-end TREBL analysis pipeline orchestrator.</p>
<p>This class coordinates the complete TREBL workflow including initial barcode
mapping, quality filtering, error correction, UMI deduplication, and activity
score calculations. Supports both simple validation workflows and complex
experimental analyses with multiple samples and replicates.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>db_path</strong> (<em>str</em>) – Path to the DuckDB database file. Will be created if
it doesn’t exist.</p></li>
<li><p><strong>design_file_path</strong> (<em>str</em><em> or </em><em>None</em>) – Path to the design validation file.
If None, design-based filtering is skipped throughout the pipeline.</p></li>
<li><p><strong>error_correction</strong> (<em>bool</em><em>, </em><em>optional</em>) – Whether to enable UMI-tools based
error correction during refinement steps. Defaults to False.</p></li>
<li><p><strong>output_path</strong> (<em>str</em><em> or </em><em>Path</em><em>, </em><em>optional</em>) – Output directory for results,
figures, and intermediate files. If None, results are not saved
to disk. Defaults to None.</p></li>
<li><p><strong>test_n_reads</strong> (<em>int</em><em> or </em><em>bool</em><em>, </em><em>optional</em>) – If set to an integer, limits
initial mapping to the first N reads for rapid testing/debugging.
If False, processes all reads. Defaults to False.</p></li>
</ul>
</dd>
</dl>
<p class="rubric">Example</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Initialize pipeline for full experiment</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">pipeline</span> <span class="o">=</span> <span class="n">TreblPipeline</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">db_path</span><span class="o">=</span><span class="s2">&quot;experiment.duckdb&quot;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">design_file_path</span><span class="o">=</span><span class="s2">&quot;designs.csv&quot;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">error_correction</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">output_path</span><span class="o">=</span><span class="s2">&quot;results/&quot;</span>
<span class="gp">... </span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># Run Step 1: Initial barcode mapping</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">step1_df</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">run_step_1</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">seq_file</span><span class="o">=</span><span class="s2">&quot;step1_reads.fastq&quot;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">bc_objects</span><span class="o">=</span><span class="p">[</span><span class="n">ad_bc</span><span class="p">,</span> <span class="n">rep_bc</span><span class="p">],</span>
<span class="gp">... </span>    <span class="n">column_pairs</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;REP_BC&quot;</span><span class="p">,</span> <span class="s2">&quot;AD&quot;</span><span class="p">)],</span>
<span class="gp">... </span>    <span class="n">reads_threshold</span><span class="o">=</span><span class="mi">10</span>
<span class="gp">... </span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># Analyze full experiment with UMI deduplication</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">results</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">trebl_experiment_analysis</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">AD_seq_files</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;ad_sample1.fastq&quot;</span><span class="p">,</span> <span class="s2">&quot;ad_sample2.fastq&quot;</span><span class="p">],</span>
<span class="gp">... </span>    <span class="n">AD_bc_objects</span><span class="o">=</span><span class="p">[</span><span class="n">ad_bc</span><span class="p">,</span> <span class="n">adbc_bc</span><span class="p">],</span>
<span class="gp">... </span>    <span class="n">RT_seq_files</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;rt_sample1.fastq&quot;</span><span class="p">,</span> <span class="s2">&quot;rt_sample2.fastq&quot;</span><span class="p">],</span>
<span class="gp">... </span>    <span class="n">RT_bc_objects</span><span class="o">=</span><span class="p">[</span><span class="n">rt_bc</span><span class="p">],</span>
<span class="gp">... </span>    <span class="n">reverse_complement</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">AD_umi_object</span><span class="o">=</span><span class="n">umi_obj</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">RT_umi_object</span><span class="o">=</span><span class="n">umi_obj</span>
<span class="gp">... </span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># Calculate final activity scores</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">mean_activity</span><span class="p">,</span> <span class="n">summed_activity</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">calculate_activity_scores</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">step1_path</span><span class="o">=</span><span class="s2">&quot;results/step1.csv&quot;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">AD_bc_objects</span><span class="o">=</span><span class="p">[</span><span class="n">ad_bc</span><span class="p">,</span> <span class="n">adbc_bc</span><span class="p">],</span>
<span class="gp">... </span>    <span class="n">RT_bc_objects</span><span class="o">=</span><span class="p">[</span><span class="n">rt_bc</span><span class="p">],</span>
<span class="gp">... </span>    <span class="n">time_regex</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;(\d+)h&quot;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">rep_regex</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;rep(\d+)&quot;</span>
<span class="gp">... </span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The pipeline automatically handles table naming, intermediate file management,
and result aggregation across multiple samples. All processing steps are
logged and intermediate results are saved for debugging and validation.</p>
</div>
<dl class="py method">
<dt class="sig sig-object py" id="trebl_tools.pipelines.TreblPipeline.__init__">
<span class="sig-name descname"><span class="pre">__init__</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">db_path</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">design_file_path</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">error_correction</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">output_path</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">test_n_reads</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/trebl_tools/pipelines.html#TreblPipeline.__init__"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#trebl_tools.pipelines.TreblPipeline.__init__" title="Link to this definition"></a></dt>
<dd><p>Initialize a TREBL pipeline run.</p>
<p>Sets up database connection, output directories, and processing configuration.
Creates necessary directory structure for results and figures if output_path
is provided.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>db_path</strong> (<em>str</em>) – Path to the DuckDB database file. Will be created if
it doesn’t exist.</p></li>
<li><p><strong>design_file_path</strong> (<em>str</em><em> or </em><em>None</em>) – Path to the design validation file.
If None, design-based filtering is skipped throughout the pipeline.</p></li>
<li><p><strong>error_correction</strong> (<em>bool</em><em>, </em><em>optional</em>) – Whether to enable UMI-tools based
error correction during refinement steps. Defaults to False.</p></li>
<li><p><strong>output_path</strong> (<em>str</em><em> or </em><em>Path</em><em>, </em><em>optional</em>) – Output directory for results,
figures, and intermediate files. If None, results are not saved
to disk. Defaults to None.</p></li>
<li><p><strong>test_n_reads</strong> (<em>int</em><em> or </em><em>bool</em><em>, </em><em>optional</em>) – If set to an integer, limits
initial mapping to the first N reads for rapid testing/debugging.
If False, processes all reads. Defaults to False.</p></li>
</ul>
</dd>
</dl>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>When output_path is provided, creates subdirectories:
- {output_path}/figures/ for all plots and visualizations
- {output_path}/{sample_name}/ for per-sample intermediate files</p>
</div>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="trebl_tools.pipelines.TreblPipeline.calculate_activity_scores">
<span class="sig-name descname"><span class="pre">calculate_activity_scores</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">step1_path</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">AD_bc_objects</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">RT_bc_objects</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">time_regex</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">rep_regex</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/trebl_tools/pipelines.html#TreblPipeline.calculate_activity_scores"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#trebl_tools.pipelines.TreblPipeline.calculate_activity_scores" title="Link to this definition"></a></dt>
<dd><p>Compute activity scores from AD and RT experiment results using Step 1 mapping.</p>
<p>Calculates two complementary activity metrics by combining AD library UMI counts
(input) with RT library UMI counts (output) using the Step 1 barcode-to-gene
mapping as the linking table. Returns a consolidated table with both per-barcode
averaged activity and summed activity calculations.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>step1_path</strong> (<em>str</em>) – Path to the Step 1 mapping CSV file containing the
canonical barcode-to-gene relationships.</p></li>
<li><p><strong>AD_bc_objects</strong> (<em>list</em><em>[</em><a class="reference internal" href="#trebl_tools.finder.Barcode" title="trebl_tools.finder.Barcode"><em>Barcode</em></a><em>]</em>) – List of AD barcode objects with <cite>.name</cite>
attributes corresponding to columns in the Step 1 mapping.</p></li>
<li><p><strong>RT_bc_objects</strong> (<em>list</em><em>[</em><a class="reference internal" href="#trebl_tools.finder.Barcode" title="trebl_tools.finder.Barcode"><em>Barcode</em></a><em>]</em>) – List of RT barcode objects with <cite>.name</cite>
attributes for reporter identification.</p></li>
<li><p><strong>time_regex</strong> (<em>str</em>) – Regular expression to extract timepoint values from
sample names. Should contain a capture group for the time value.
Example: r”(d+)h” for “2h”, r”t(d+)” for “t24”.</p></li>
<li><p><strong>rep_regex</strong> (<em>str</em>) – Regular expression to extract replicate identifiers
from sample names. Should contain a capture group for replicate number.
Example: r”rep(d+)” for “rep1”, r”r(d+)” for “r2”.</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p><dl>
<dt>Consolidated activity scores table with hierarchical columns:</dt><dd><ul class="simple">
<li><p>Index: (AD, replicate) multi-index</p></li>
<li><dl class="simple">
<dt>Columns: Multi-level structure with:</dt><dd><ul>
<li><p>Level 0: timepoint values (e.g., 0, 2, 24)</p></li>
<li><p>Level 1: metric types (‘mean_activity’, ‘std_activity’, ‘summed_activity’)</p></li>
</ul>
</dd>
</dl>
</li>
</ul>
<dl>
<dt>Example structure:</dt><dd><blockquote>
<div><p>0                    2                    24</p>
</div></blockquote>
<p>mean  std  sum      mean  std  sum      mean  std  sum</p>
</dd>
</dl>
<p>AD    rep
GENE1  1      0.45  0.12  0.52    1.23  0.34  1.15    2.10  0.67  1.98</p>
<blockquote>
<div><p>2      0.48  0.15  0.55    1.18  0.29  1.12    2.05  0.71  1.95</p>
</div></blockquote>
</dd>
</dl>
</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>pd.DataFrame</p>
</dd>
</dl>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>Activity Score Calculations:</strong></p>
<ol class="arabic simple">
<li><dl class="simple">
<dt><strong>Averaged Activity (Per-Barcode)</strong>:</dt><dd><ul class="simple">
<li><p>For each barcode: activity = RT_UMIs / AD_UMIs</p></li>
<li><p>Mean and std calculated per (AD, time, rep) group</p></li>
<li><p>Results show variability across barcodes within each gene</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><strong>Summed Activity (Per-Gene)</strong>:</dt><dd><ul class="simple">
<li><p>For each (AD, time, rep): sum all AD_UMIs and RT_UMIs across barcodes</p></li>
<li><p>activity = sum(RT_UMIs) / sum(AD_UMIs)</p></li>
<li><p>Results show overall gene-level activity</p></li>
</ul>
</dd>
</dl>
</li>
</ol>
<p><strong>Output Files (if output_path configured):</strong>
- <cite>unaggregated_activities.csv</cite>: Raw per-barcode activity scores
- <cite>consolidated_activity_scores.csv</cite>: Combined table with all metrics</p>
<p><strong>Data Integration Workflow:</strong>
1. Load AD and RT experiment results from previous analysis
2. Extract time/replicate metadata using provided regex patterns
3. Merge with Step 1 mapping to link AD and RT measurements
4. Calculate per-barcode activity ratios
5. Aggregate using both averaging and summing strategies
6. Consolidate into single multi-level DataFrame</p>
</div>
<p class="rubric">Example</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">activity_df</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">calculate_activity_scores</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">step1_path</span><span class="o">=</span><span class="s2">&quot;results/step1.csv&quot;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">AD_bc_objects</span><span class="o">=</span><span class="p">[</span><span class="n">ad_bc</span><span class="p">,</span> <span class="n">adbc_bc</span><span class="p">],</span>
<span class="gp">... </span>    <span class="n">RT_bc_objects</span><span class="o">=</span><span class="p">[</span><span class="n">rt_bc</span><span class="p">],</span>
<span class="gp">... </span>    <span class="n">time_regex</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;(\d+)h&quot;</span><span class="p">,</span>          <span class="c1"># Extract &quot;24&quot; from &quot;24h&quot;</span>
<span class="gp">... </span>    <span class="n">rep_regex</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;rep(\d+)&quot;</span>          <span class="c1"># Extract &quot;1&quot; from &quot;rep1&quot;</span>
<span class="gp">... </span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Activity table shape:&quot;</span><span class="p">,</span> <span class="n">activity_df</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Available timepoints:&quot;</span><span class="p">,</span> <span class="n">activity_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Available metrics:&quot;</span><span class="p">,</span> <span class="n">activity_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
<span class="gp">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># Access specific metric for all timepoints</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">mean_activities</span> <span class="o">=</span> <span class="n">activity_df</span><span class="o">.</span><span class="n">xs</span><span class="p">(</span><span class="s1">&#39;mean_activity&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">summed_activities</span> <span class="o">=</span> <span class="n">activity_df</span><span class="o">.</span><span class="n">xs</span><span class="p">(</span><span class="s1">&#39;summed_activity&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<dl class="field-list simple">
<dt class="field-odd">Raises<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>ValueError</strong> – If regex patterns fail to match sample names</p></li>
<li><p><strong>FileNotFoundError</strong> – If required input CSV files are not found</p></li>
<li><p><strong>KeyError</strong> – If expected columns are missing from input files</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="trebl_tools.pipelines.TreblPipeline.plot_trebl_experiment_loss">
<span class="sig-name descname"><span class="pre">plot_trebl_experiment_loss</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">bc_objects</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">step1_map_name</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">step_name_prefix</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'trebl_experiment_'</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/trebl_tools/pipelines.html#TreblPipeline.plot_trebl_experiment_loss"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#trebl_tools.pipelines.TreblPipeline.plot_trebl_experiment_loss" title="Link to this definition"></a></dt>
<dd><p>Plot barcode quality and mapping loss for a TREBL experiment.</p>
<dl class="simple">
<dt>Generates bar plots showing:</dt><dd><ol class="arabic simple">
<li><p>Total number of reads in each initial mapping table.</p></li>
<li><p>Number of reads passing barcode quality checks (<cite>_qual</cite> columns).</p></li>
<li><p>Number of reads that match the Step 1 map for all barcodes.</p></li>
</ol>
</dd>
</dl>
<p>Plots are saved as a PNG file in <cite>self.output_figures_path</cite> and
returned as Matplotlib figure and axes objects.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>bc_objects</strong> (<em>list</em>) – List of barcode objects to evaluate.</p></li>
<li><p><strong>step1_map_name</strong> (<em>str</em>) – Name of the Step 1 DuckDB table used to
calculate overlap with mapped barcodes.</p></li>
<li><p><strong>step_name_prefix</strong> (<em>str</em><em>, </em><em>optional</em>) – Prefix used to identify TREBL
experiment tables in DuckDB. Defaults to “<a href="#id4"><span class="problematic" id="id5">trebl_experiment_</span></a>”.</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p><dl class="simple">
<dt>(fig, axes)</dt><dd><ul class="simple">
<li><p>fig (matplotlib.figure.Figure): Figure object containing all subplots.</p></li>
<li><p>axes (list[matplotlib.axes._subplots.AxesSubplot]): Flattened list of subplot axes.
Returns None, None if no matching tables are found.</p></li>
</ul>
</dd>
</dl>
</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>tuple</p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="trebl_tools.pipelines.TreblPipeline.reads_distribution">
<span class="sig-name descname"><span class="pre">reads_distribution</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">seq_file</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">bc_objects</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">step_name</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">reverse_complement</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/trebl_tools/pipelines.html#TreblPipeline.reads_distribution"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#trebl_tools.pipelines.TreblPipeline.reads_distribution" title="Link to this definition"></a></dt>
<dd><p>Visualize read-count distributions for threshold determination.</p>
<p>Performs initial mapping and grouping for a single FASTQ file and generates
a histogram showing the distribution of read counts per barcode combination.
This analysis helps determine appropriate read count thresholds for filtering.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>seq_file</strong> (<em>str</em>) – Path to FASTQ file containing sequences for analysis.</p></li>
<li><p><strong>bc_objects</strong> (<em>list</em><em>[</em><a class="reference internal" href="#trebl_tools.finder.Barcode" title="trebl_tools.finder.Barcode"><em>Barcode</em></a><em>]</em>) – Barcode objects defining extraction patterns
and expected lengths for the library.</p></li>
<li><p><strong>step_name</strong> (<em>str</em>) – Step identifier used for DuckDB table naming and
plot titles.</p></li>
<li><p><strong>reverse_complement</strong> (<em>bool</em>) – Whether sequences should be reverse
complemented prior to barcode extraction.</p></li>
</ul>
</dd>
</dl>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Creates grouped barcode combinations table and generates a read count
histogram. Useful for determining reads_threshold parameters before
running full refinement pipelines.</p>
</div>
<p class="rubric">Example</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">pipeline</span><span class="o">.</span><span class="n">reads_distribution</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">seq_file</span><span class="o">=</span><span class="s2">&quot;test_reads.fastq&quot;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">bc_objects</span><span class="o">=</span><span class="p">[</span><span class="n">ad_bc</span><span class="p">,</span> <span class="n">rep_bc</span><span class="p">],</span>
<span class="gp">... </span>    <span class="n">step_name</span><span class="o">=</span><span class="s2">&quot;threshold_test&quot;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">reverse_complement</span><span class="o">=</span><span class="kc">True</span>
<span class="gp">... </span><span class="p">)</span>
<span class="go"># Generates histogram showing read count distribution</span>
</pre></div>
</div>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="trebl_tools.pipelines.TreblPipeline.run_step_1">
<span class="sig-name descname"><span class="pre">run_step_1</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">seq_file</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">bc_objects</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">column_pairs</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">reads_threshold</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">reverse_complement</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">step_suffix</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">''</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/trebl_tools/pipelines.html#TreblPipeline.run_step_1"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#trebl_tools.pipelines.TreblPipeline.run_step_1" title="Link to this definition"></a></dt>
<dd><p>Run TREBL Step 1: map reads to designed AD barcodes.</p>
<p>Performs initial mapping, refinement, optional error correction,
and outputs the final designed map.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>seq_file</strong> (<em>str</em>) – FASTQ file containing Step 1 reads.</p></li>
<li><p><strong>bc_objects</strong> (<em>list</em>) – Barcode objects defining extraction rules.</p></li>
<li><p><strong>column_pairs</strong> (<em>list</em><em>[</em><em>tuple</em><em>]</em>) – <p>Column-pair checks used
to remove barcode collisions.</p>
<p>Each tuple has the form:</p>
<blockquote>
<div><p>(key_column(s), target_column(s))</p>
</div></blockquote>
<p>where <cite>key_column(s)</cite> and <cite>target_column(s)</cite> can be either
a single column name (str) or a tuple/list of column names.</p>
<p>The constraint enforces that, for each <strong>key</strong>, at least
90% of its reads must map to a single <strong>target</strong>. If a key
value maps to multiple targets without one reaching the 90%
threshold, the key is considered ambiguous and discarded.</p>
<p><strong>Single-column example</strong>:</p>
<blockquote>
<div><p>column_pairs = [(“RPTR_BC”, “AD”)]</p>
</div></blockquote>
<p>This ensures that each reporter barcode (<code class="docutils literal notranslate"><span class="pre">RPTR_BC</span></code>) maps
predominantly to a single AD. If a reporter barcode has
reads mapping to multiple ADs without one exceeding 90%,
that reporter barcode is removed.</p>
<p><strong>Multi-column example</strong>:</p>
<blockquote>
<div><dl class="simple">
<dt>column_pairs = [</dt><dd><p>((“RPTR_BC”), (“Hawk_BC”, “AD_BC”))</p>
</dd>
</dl>
<p>]</p>
</div></blockquote>
<p>This checks that each RPTR BC
maps to a single Hawkins AD barcode and AD barcode combination
with ≥90% of reads. Ambiguous key combinations are removed.</p>
<p>Multiple constraints may be applied sequentially:</p>
<blockquote>
<div><dl class="simple">
<dt>column_pairs = [</dt><dd><p>(“AD_BC”, “AD”),
(“RPTR_BC”, “AD”),
((“AD_BC”, “RPTR_BC”), (“AD”, “SampleID”)),</p>
</dd>
</dl>
<p>]</p>
</div></blockquote>
</p></li>
<li><p><strong>reads_threshold</strong> (<em>int</em>) – Minimum number of reads required for a
barcode or barcode pair to be kept.</p></li>
<li><p><strong>reverse_complement</strong> (<em>bool</em><em>, </em><em>optional</em>) – Whether reads should be
reverse complemented prior to barcode extraction.
Defaults to False.</p></li>
<li><p><strong>step_suffix</strong> (<em>str</em><em>, </em><em>optional</em>) – <p>Suffix appended to the step name
for DuckDB table naming. This is useful when you want
to distinguish multiple runs or subsets of the same step.</p>
<p class="rubric">Example</p>
<p>”_spike_in” — if processing spike-in samples separately
from your main dataset.
“_new_data” — for data from new sequencing run.</p>
</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>Final designed Step 1 mapping after all refinement
steps have been applied.</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>pd.DataFrame</p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="trebl_tools.pipelines.TreblPipeline.run_step_2">
<span class="sig-name descname"><span class="pre">run_step_2</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">AD_seq_file</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">AD_bc_objects</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">RT_seq_file</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">RT_bc_objects</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">reverse_complement</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">reads_threshold_AD</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">reads_threshold_RT</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">step1_map_csv_path</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">step_suffix</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">''</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/trebl_tools/pipelines.html#TreblPipeline.run_step_2"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#trebl_tools.pipelines.TreblPipeline.run_step_2" title="Link to this definition"></a></dt>
<dd><p>Run TREBL Step 2: Analyze intermediate complexity.</p>
<p>Performs separate refinement for AD and RT libraries and computes
overlap with the Step 1 map.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>AD_seq_file</strong> (<em>str</em>) – FASTQ file containing AD reads.</p></li>
<li><p><strong>AD_bc_objects</strong> (<em>list</em>) – Barcode objects for ADs.</p></li>
<li><p><strong>RT_seq_file</strong> (<em>str</em>) – FASTQ file containing RT reads.</p></li>
<li><p><strong>RT_bc_objects</strong> (<em>list</em>) – Barcode objects for reporters.</p></li>
<li><p><strong>reverse_complement</strong> (<em>bool</em>) – Whether to reverse complement reads.</p></li>
<li><p><strong>reads_threshold_AD</strong> (<em>int</em>) – Minimum reads per AD barcode.</p></li>
<li><p><strong>reads_threshold_RT</strong> (<em>int</em>) – Minimum reads per RT barcode.</p></li>
<li><p><strong>step1_map_csv_path</strong> (<em>str</em>) – Path to the Step 1 map CSV file.</p></li>
<li><p><strong>step_suffix</strong> (<em>str</em><em>, </em><em>optional</em>) – Suffix appended to the step name.</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p><dl class="simple">
<dt>Dictionary with keys:</dt><dd><ul class="simple">
<li><p>”AD_step2”: AD DataFrame</p></li>
<li><p>”RT_step2”: RT DataFrame</p></li>
<li><p>”step1_overlap”: Overlap statistics</p></li>
</ul>
</dd>
</dl>
</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>dict</p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="trebl_tools.pipelines.TreblPipeline.step1_reads_distribution">
<span class="sig-name descname"><span class="pre">step1_reads_distribution</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">seq_file</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">bc_objects</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">reverse_complement</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">step_suffix</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">''</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/trebl_tools/pipelines.html#TreblPipeline.step1_reads_distribution"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#trebl_tools.pipelines.TreblPipeline.step1_reads_distribution" title="Link to this definition"></a></dt>
<dd><p>Convenience wrapper for Step 1 read distributions.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>seq_file</strong> (<em>str</em>) – FASTQ file path.</p></li>
<li><p><strong>bc_objects</strong> (<em>list</em>) – Barcode objects.</p></li>
<li><p><strong>reverse_complement</strong> (<em>bool</em>) – Whether to reverse complement reads.</p></li>
<li><p><strong>step_suffix</strong> (<em>str</em><em>, </em><em>optional</em>) – Suffix appended to the step name.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="trebl_tools.pipelines.TreblPipeline.step2_reads_distribution">
<span class="sig-name descname"><span class="pre">step2_reads_distribution</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">AD_seq_file</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">AD_bc_objects</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">RT_seq_file</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">RT_bc_objects</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">reverse_complement</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">step_suffix</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">''</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/trebl_tools/pipelines.html#TreblPipeline.step2_reads_distribution"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#trebl_tools.pipelines.TreblPipeline.step2_reads_distribution" title="Link to this definition"></a></dt>
<dd><p>Convenience wrapper for Step 2 AD and RT libraries.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>AD_seq_file</strong> (<em>str</em>) – FASTQ file for AD reads.</p></li>
<li><p><strong>AD_bc_objects</strong> (<em>list</em>) – AD barcode objects.</p></li>
<li><p><strong>RT_seq_file</strong> (<em>str</em>) – FASTQ file for RT reads.</p></li>
<li><p><strong>RT_bc_objects</strong> (<em>list</em>) – RT barcode objects.</p></li>
<li><p><strong>reverse_complement</strong> (<em>bool</em>) – Whether to reverse complement reads.</p></li>
<li><p><strong>step_suffix</strong> (<em>str</em><em>, </em><em>optional</em>) – Suffix appended to the step name.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="trebl_tools.pipelines.TreblPipeline.trebl_experiment_analysis">
<span class="sig-name descname"><span class="pre">trebl_experiment_analysis</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">AD_seq_files</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">AD_bc_objects</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">RT_seq_files</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">RT_bc_objects</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">reverse_complement</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">step1_map_csv_path</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">AD_umi_object</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">RT_umi_object</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">reads_threshold_AD</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">1</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">reads_threshold_RT</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">1</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">step_name_suffix</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">''</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">umi_deduplication</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'both'</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/trebl_tools/pipelines.html#TreblPipeline.trebl_experiment_analysis"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#trebl_tools.pipelines.TreblPipeline.trebl_experiment_analysis" title="Link to this definition"></a></dt>
<dd><p>Run TREBL experiment analysis for both AD and RT libraries.</p>
<p>The workflow automatically selects between a UMI or non-UMI
pipeline depending on whether a UMI object is provided. If UMI deduplication
is enabled, results from simple and/or directional/complex deduplication are merged.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>AD_seq_files</strong> (<em>list</em><em>[</em><em>str</em><em>]</em>) – Paths to FASTQ files for AD library reads.</p></li>
<li><p><strong>AD_bc_objects</strong> (<em>list</em>) – Barcode objects for AD library extraction.</p></li>
<li><p><strong>RT_seq_files</strong> (<em>list</em><em>[</em><em>str</em><em>]</em>) – Paths to FASTQ files for reporter (RT) reads.</p></li>
<li><p><strong>RT_bc_objects</strong> (<em>list</em>) – Barcode objects for reporter library extraction.</p></li>
<li><p><strong>reverse_complement</strong> (<em>bool</em>) – Whether reads should be reverse complemented prior to barcode extraction.</p></li>
<li><p><strong>step1_map_csv_path</strong> (<em>str</em><em>, </em><em>optional</em>) – Path to Step 1 map CSV for computing overlap plots.</p></li>
<li><p><strong>AD_umi_object</strong> (<em>optional</em>) – UMI object for AD library. If provided, triggers UMI deduplication.</p></li>
<li><p><strong>RT_umi_object</strong> (<em>optional</em>) – UMI object for RT library. If provided, triggers UMI deduplication.</p></li>
<li><p><strong>reads_threshold_AD</strong> (<em>int</em><em>, </em><em>optional</em>) – Minimum reads per AD barcode to retain. Defaults to 1.</p></li>
<li><p><strong>reads_threshold_RT</strong> (<em>int</em><em>, </em><em>optional</em>) – Minimum reads per RT barcode to retain. Defaults to 1.</p></li>
<li><p><strong>step_name_suffix</strong> (<em>str</em><em>, </em><em>optional</em>) – Suffix for DuckDB table and output names.</p></li>
<li><p><strong>umi_deduplication</strong> (<em>str</em><em>, </em><em>optional</em>) – <p>Deduplication mode for both AD and RT libraries.
Options:</p>
<blockquote>
<div><ul>
<li><p>’simple’: Only simple UMI deduplication is applied.</p></li>
<li><p>’both’ (default): Both simple and directional/complex deduplication are performed.</p></li>
</ul>
</div></blockquote>
</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p><dl class="simple">
<dt>Dictionary containing final TREBL experiment results:</dt><dd><ul class="simple">
<li><p>”AD_results” (pd.DataFrame): AD library results with merged UMI counts if UMI workflow.</p></li>
<li><p>”RT_results” (pd.DataFrame): RT library results with merged UMI counts if UMI workflow.</p></li>
</ul>
</dd>
</dl>
</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>dict</p>
</dd>
</dl>
<p class="rubric">Notes</p>
<ul class="simple">
<li><p>UMI-based workflows produce two count tables per sample:</p></li>
</ul>
<p>simple UMI counts and directional/complex UMI counts. These are merged in the final output.
- Non-UMI workflows return barcode counts after grouping, thresholding, and optional error correction.
- If <cite>output_path</cite> is set, results are saved as CSV:</p>
<blockquote>
<div><p>“{output_path}/AD_trebl_experiment_results.csv” and
“{output_path}/RT_trebl_experiment_results.csv”.</p>
</div></blockquote>
<ul class="simple">
<li><p>Barcode quality/loss plots are generated for both AD and RT libraries.</p></li>
</ul>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="trebl_tools.pipelines.TreblPipeline.trebl_experiment_reads_distribution">
<span class="sig-name descname"><span class="pre">trebl_experiment_reads_distribution</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">AD_seq_files</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">AD_bc_objects</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">RT_seq_files</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">RT_bc_objects</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">reverse_complement</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">step_suffix</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">''</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/trebl_tools/pipelines.html#TreblPipeline.trebl_experiment_reads_distribution"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#trebl_tools.pipelines.TreblPipeline.trebl_experiment_reads_distribution" title="Link to this definition"></a></dt>
<dd><p>Convenience wrapper for TREBL Experiment AD and RT libraries.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>AD_seq_file</strong> (<em>str</em>) – FASTQ file for AD reads.</p></li>
<li><p><strong>AD_bc_objects</strong> (<em>list</em>) – AD barcode objects.</p></li>
<li><p><strong>RT_seq_file</strong> (<em>str</em>) – FASTQ file for RT reads.</p></li>
<li><p><strong>RT_bc_objects</strong> (<em>list</em>) – RT barcode objects.</p></li>
<li><p><strong>reverse_complement</strong> (<em>bool</em>) – Whether to reverse complement reads.</p></li>
<li><p><strong>step_suffix</strong> (<em>str</em><em>, </em><em>optional</em>) – Suffix appended to the step name.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

</dd></dl>

</section>
<section id="module-trebl_tools.plotting">
<span id="trebl-tools-plotting-module"></span><h2>trebl_tools.plotting module<a class="headerlink" href="#module-trebl_tools.plotting" title="Link to this heading"></a></h2>
<dl class="py function">
<dt class="sig sig-object py" id="trebl_tools.plotting.plot_all_whitelists_from_summary">
<span class="sig-prename descclassname"><span class="pre">trebl_tools.plotting.</span></span><span class="sig-name descname"><span class="pre">plot_all_whitelists_from_summary</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">summary_df</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">n_cols</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">4</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">dpi</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">300</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/trebl_tools/plotting.html#plot_all_whitelists_from_summary"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#trebl_tools.plotting.plot_all_whitelists_from_summary" title="Link to this definition"></a></dt>
<dd><p>Create comprehensive visualization of barcode error correction summary.</p>
<p>Generates a multi-panel figure showing various aspects of barcode error
correction performance including sequence reduction, group size distributions,
and read count relationships between canonical and collapsed sequences.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>summary_df</strong> (<em>pd.DataFrame</em>) – DataFrame with error correction summary data.
Must contain columns: [‘canonical’, ‘num_merged’, ‘largest_count’, ‘rest_count’].</p></li>
<li><p><strong>n_cols</strong> (<em>int</em><em>, </em><em>optional</em>) – Number of panels per row. Currently fixed at 4
for the standard panel layout. Defaults to 4.</p></li>
<li><p><strong>dpi</strong> (<em>int</em><em>, </em><em>optional</em>) – Figure resolution in dots per inch. Defaults to 300.</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p><dl class="simple">
<dt>Figure object containing four panels:</dt><dd><ul class="simple">
<li><p>Panel 1: Bar chart of sequence counts before/after correction</p></li>
<li><p>Panel 2: Histogram of group sizes (number of sequences per canonical)</p></li>
<li><p>Panel 3: Scatter plot of largest member count vs group size</p></li>
<li><p>Panel 4: Log-log scatter of largest vs summed smaller member counts</p></li>
</ul>
</dd>
</dl>
</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>matplotlib.figure.Figure</p>
</dd>
</dl>
<p class="rubric">Example</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">summary_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
<span class="gp">... </span>    <span class="s1">&#39;num_merged&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
<span class="gp">... </span>    <span class="s1">&#39;largest_count&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">1000</span><span class="p">],</span>
<span class="gp">... </span>    <span class="s1">&#39;rest_count&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">150</span><span class="p">]</span>
<span class="gp">... </span><span class="p">})</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">fig</span> <span class="o">=</span> <span class="n">plot_all_whitelists_from_summary</span><span class="p">(</span><span class="n">summary_df</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Panel 4 includes a diagonal reference line (y=x) to show the relationship
between canonical and collapsed sequence read counts. Uses seaborn ‘Paired’
color palette for consistent styling.</p>
</div>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="trebl_tools.plotting.plot_error_correction">
<span class="sig-prename descclassname"><span class="pre">trebl_tools.plotting.</span></span><span class="sig-name descname"><span class="pre">plot_error_correction</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">output_figures_path</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">table_prefix_with_descriptor</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">plot</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">True</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/trebl_tools/plotting.html#plot_error_correction"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#trebl_tools.plotting.plot_error_correction" title="Link to this definition"></a></dt>
<dd><p>Summarize and visualize error correction results from whitelist files.</p>
<p>Processes whitelist files generated during error correction to create
summary statistics and visualizations of barcode collapse and correction
performance. Reads the first whitelist file found and generates comprehensive
plots showing before/after sequence counts and correction statistics.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>output_figures_path</strong> (<em>str</em><em> or </em><em>Path</em>) – Directory containing whitelist files
and where output plots will be saved.</p></li>
<li><p><strong>table_prefix_with_descriptor</strong> (<em>str</em>) – Prefix for output filenames.</p></li>
<li><p><strong>plot</strong> (<em>bool</em><em>, </em><em>optional</em>) – Whether to generate and save plots.
Defaults to True.</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p><dl class="simple">
<dt>Summary table with columns:</dt><dd><ul class="simple">
<li><p>canonical: Canonical barcode sequence</p></li>
<li><p>collapsed: Comma-separated list of collapsed sequences</p></li>
<li><p>largest_count: Read count of most abundant sequence in group</p></li>
<li><p>counts: Comma-separated counts of collapsed sequences</p></li>
<li><p>collapsed_list: List of collapsed sequences</p></li>
<li><p>num_merged: Number of sequences merged into canonical</p></li>
<li><p>rest_count: Sum of counts from non-canonical sequences</p></li>
</ul>
</dd>
</dl>
</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>pd.DataFrame</p>
</dd>
<dt class="field-even">Raises<span class="colon">:</span></dt>
<dd class="field-even"><p><strong>FileNotFoundError</strong> – If no whitelist files (<a href="#id2"><span class="problematic" id="id3">*</span></a>_whitelist.txt) are found
    in the specified directory.</p>
</dd>
</dl>
<p class="rubric">Example</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">summary</span> <span class="o">=</span> <span class="n">plot_error_correction</span><span class="p">(</span>
<span class="gp">... </span>    <span class="s2">&quot;results/error_corrected/&quot;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="s2">&quot;step1_&quot;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">plot</span><span class="o">=</span><span class="kc">True</span>
<span class="gp">... </span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processed </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">summary</span><span class="p">)</span><span class="si">}</span><span class="s2"> canonical barcodes&quot;</span><span class="p">)</span>
<span class="go">Saved barcode whitelist plots: results/error_corrected/step1_whitelist_summary.png</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Expects whitelist files to have tab-separated format with columns:
canonical, collapsed, largest_count, counts. Uses seaborn ‘talk’ context
for plot styling.</p>
</div>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="trebl_tools.plotting.plot_loss_helper">
<span class="sig-prename descclassname"><span class="pre">trebl_tools.plotting.</span></span><span class="sig-name descname"><span class="pre">plot_loss_helper</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">ax</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">palette</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">text_offset</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">show_background</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">default_map_order</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">output_figures_path</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">table_prefix_with_descriptor</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">df</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/trebl_tools/plotting.html#plot_loss_helper"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#trebl_tools.plotting.plot_loss_helper" title="Link to this definition"></a></dt>
<dd><p>Generate horizontal bar plot showing read loss through processing pipeline steps.</p>
<p>Creates a visualization showing both total reads and unique counts at each
step of the processing pipeline, with optional background bars to show
the difference between total and unique counts.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>ax</strong> (<em>matplotlib.axes.Axes</em><em> or </em><em>None</em>) – Existing axis to plot on. If None,
a new figure is created.</p></li>
<li><p><strong>palette</strong> (<em>str</em>) – Name of seaborn color palette to use for bars.</p></li>
<li><p><strong>text_offset</strong> (<em>float</em>) – Vertical offset for read count labels to avoid overlap.</p></li>
<li><p><strong>show_background</strong> (<em>bool</em>) – Whether to show background bars for total reads
with reduced alpha transparency.</p></li>
<li><p><strong>default_map_order</strong> (<em>list</em>) – Ordered list of pipeline step names for
consistent color mapping across plots.</p></li>
<li><p><strong>output_figures_path</strong> (<em>str</em>) – Directory path where plot will be saved.</p></li>
<li><p><strong>table_prefix_with_descriptor</strong> (<em>str</em>) – Prefix for output filename.</p></li>
<li><p><strong>df</strong> (<em>pd.DataFrame</em>) – DataFrame with columns:
- description: Step descriptions for y-axis labels
- map: Pipeline step names for color mapping
- total_reads: Total read counts per step
- unique_count: Unique sequence counts per step</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>(fig, ax) matplotlib Figure and Axes objects.</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>tuple</p>
</dd>
</dl>
<p class="rubric">Example</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
<span class="gp">... </span>    <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Step 1&#39;</span><span class="p">,</span> <span class="s1">&#39;Step 2&#39;</span><span class="p">],</span>
<span class="gp">... </span>    <span class="s1">&#39;map&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;map1&#39;</span><span class="p">,</span> <span class="s1">&#39;map2&#39;</span><span class="p">],</span>
<span class="gp">... </span>    <span class="s1">&#39;total_reads&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">10000</span><span class="p">,</span> <span class="mi">8000</span><span class="p">],</span>
<span class="gp">... </span>    <span class="s1">&#39;unique_count&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">5000</span><span class="p">,</span> <span class="mi">4000</span><span class="p">]</span>
<span class="gp">... </span><span class="p">})</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plot_loss_helper</span><span class="p">(</span>
<span class="gp">... </span>    <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;Set2&#39;</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;map1&#39;</span><span class="p">,</span> <span class="s1">&#39;map2&#39;</span><span class="p">],</span>
<span class="gp">... </span>    <span class="s1">&#39;results/&#39;</span><span class="p">,</span> <span class="s1">&#39;sample_&#39;</span><span class="p">,</span> <span class="n">df</span>
<span class="gp">... </span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Automatically saves plot to output_figures_path with filename
“{table_prefix_with_descriptor}loss.png”.</p>
</div>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="trebl_tools.plotting.plot_reads_histogram">
<span class="sig-prename descclassname"><span class="pre">trebl_tools.plotting.</span></span><span class="sig-name descname"><span class="pre">plot_reads_histogram</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">map_df</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">save_path</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">ax</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">**</span></span><span class="n"><span class="pre">kwargs</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/trebl_tools/plotting.html#plot_reads_histogram"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#trebl_tools.plotting.plot_reads_histogram" title="Link to this definition"></a></dt>
<dd><p>Plot a histogram of read counts on a log-log scale.</p>
<p>Creates a histogram visualization of read count distributions using
logarithmic scaling on both axes for better visualization of wide
dynamic ranges typical in sequencing data.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>map_df</strong> (<em>pd.DataFrame</em>) – DataFrame containing at least a “count” column
with read count values.</p></li>
<li><p><strong>save_path</strong> (<em>str</em><em>, </em><em>optional</em>) – Path to save the figure. If None, figure
is not saved. Defaults to None.</p></li>
<li><p><strong>ax</strong> (<em>matplotlib.axes.Axes</em><em>, </em><em>optional</em>) – Existing axis to plot on. If None,
a new figure is created. Defaults to None.</p></li>
<li><p><strong>**kwargs</strong> – Additional keyword arguments passed to sns.histplot().</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>The axis object with the histogram plotted.</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>matplotlib.axes.Axes</p>
</dd>
</dl>
<p class="rubric">Example</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;count&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">500</span><span class="p">]})</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ax</span> <span class="o">=</span> <span class="n">plot_reads_histogram</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">save_path</span><span class="o">=</span><span class="s2">&quot;read_dist.png&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</dd></dl>

</section>
<section id="module-trebl_tools.preprocess">
<span id="trebl-tools-preprocess-module"></span><h2>trebl_tools.preprocess module<a class="headerlink" href="#module-trebl_tools.preprocess" title="Link to this heading"></a></h2>
<dl class="py function">
<dt class="sig sig-object py" id="trebl_tools.preprocess.fastp_summary_df">
<span class="sig-prename descclassname"><span class="pre">trebl_tools.preprocess.</span></span><span class="sig-name descname"><span class="pre">fastp_summary_df</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">output_dir</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/trebl_tools/preprocess.html#fastp_summary_df"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#trebl_tools.preprocess.fastp_summary_df" title="Link to this definition"></a></dt>
<dd><p>Generate summary DataFrame from fastp log files.</p>
<p>Parses fastp output log files to extract statistics about reads
passed and filtered for each sample.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>output_dir</strong> (<em>str</em>) – Directory containing the logs subdirectory with .out files.</p>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p><dl class="simple">
<dt>DataFrame with columns:</dt><dd><ul class="simple">
<li><p>sample: Sample name</p></li>
<li><p>reads_passed: Number of reads that passed filtering</p></li>
<li><p>reads_filtered: Number of reads that were filtered out</p></li>
<li><p>total_reads: Total number of reads processed</p></li>
<li><p>filtered_percent: Percentage of reads filtered</p></li>
</ul>
</dd>
</dl>
</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>pd.DataFrame</p>
</dd>
</dl>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The DataFrame is sorted by total_reads in descending order.
Log files should be in output_dir/logs/ and end with .out extension.</p>
</div>
<p class="rubric">Example</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">df</span> <span class="o">=</span> <span class="n">fastp_summary_df</span><span class="p">(</span><span class="s2">&quot;/path/to/fastp/output&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>
<span class="go">   sample  reads_passed  reads_filtered  total_reads  filtered_percent</span>
<span class="go">0  sample1       950000           50000      1000000              5.0</span>
</pre></div>
</div>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="trebl_tools.preprocess.load_and_shorten_files">
<span class="sig-prename descclassname"><span class="pre">trebl_tools.preprocess.</span></span><span class="sig-name descname"><span class="pre">load_and_shorten_files</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">seq_files</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">reverse_complement</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/trebl_tools/preprocess.html#load_and_shorten_files"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#trebl_tools.preprocess.load_and_shorten_files" title="Link to this definition"></a></dt>
<dd><p>Load sequence files (FASTQ, gzipped FASTQ, or TXT) as Dask DataFrame.</p>
<p>For FASTQ files, keeps only every 4th line starting from line 1 (the sequence line).</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>seq_files</strong> (<em>list</em><em> of </em><em>str</em><em> or </em><em>str</em>) – List of file paths or single file path.</p></li>
<li><p><strong>reverse_complement</strong> (<em>bool</em>) – Whether to apply reverse complement to sequences.</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>Loaded sequences as a Dask DataFrame with column ‘sequence’.</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>dask.DataFrame</p>
</dd>
</dl>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Supported file extensions: .fastq, .fq, .gz for FASTQ files.
Other extensions are treated as plain text files with one sequence per line.</p>
</div>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="trebl_tools.preprocess.reverse_complement">
<span class="sig-prename descclassname"><span class="pre">trebl_tools.preprocess.</span></span><span class="sig-name descname"><span class="pre">reverse_complement</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">seq</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/trebl_tools/preprocess.html#reverse_complement"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#trebl_tools.preprocess.reverse_complement" title="Link to this definition"></a></dt>
<dd><p>Return the reverse complement of a DNA sequence.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>seq</strong> (<em>str</em>) – DNA sequence string.</p>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>Reverse complement of the input sequence.</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>str</p>
</dd>
</dl>
<p class="rubric">Example</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">reverse_complement</span><span class="p">(</span><span class="s2">&quot;ATGC&quot;</span><span class="p">)</span>
<span class="go">&#39;GCAT&#39;</span>
</pre></div>
</div>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="trebl_tools.preprocess.reverse_complement_series">
<span class="sig-prename descclassname"><span class="pre">trebl_tools.preprocess.</span></span><span class="sig-name descname"><span class="pre">reverse_complement_series</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">s</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">pandas.Series</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">pandas.Series</span></span></span><a class="reference internal" href="_modules/trebl_tools/preprocess.html#reverse_complement_series"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#trebl_tools.preprocess.reverse_complement_series" title="Link to this definition"></a></dt>
<dd><p>Return the reverse complement of a pandas Series of DNA sequences.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>s</strong> (<em>pd.Series</em>) – Series of DNA sequences.</p>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>Series of reverse complemented sequences.</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>pd.Series</p>
</dd>
</dl>
<p class="rubric">Example</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="s2">&quot;ATGC&quot;</span><span class="p">,</span> <span class="s2">&quot;GATTACA&quot;</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">reverse_complement_series</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
<span class="go">0       GCAT</span>
<span class="go">1    TGTAATC</span>
<span class="go">dtype: object</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If an error occurs during reverse complement conversion,
an empty string is returned for that sequence.</p>
</div>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="trebl_tools.preprocess.run_fastp">
<span class="sig-prename descclassname"><span class="pre">trebl_tools.preprocess.</span></span><span class="sig-name descname"><span class="pre">run_fastp</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">input_dir</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">output_dir</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">script_path</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'savio_jobs/fastp.sh'</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/trebl_tools/preprocess.html#run_fastp"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#trebl_tools.preprocess.run_fastp" title="Link to this definition"></a></dt>
<dd><p>Run fastp on all .fastq.gz files using SLURM array job.</p>
<p>Submits a SLURM array job to process all .fastq.gz files in the input
directory using an existing fastp.sh script. Outputs processed files
as .fastq files.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>input_dir</strong> (<em>str</em>) – Path to folder containing .fastq.gz files.</p></li>
<li><p><strong>output_dir</strong> (<em>str</em>) – Path to folder where output should be written.</p></li>
<li><p><strong>script_path</strong> (<em>str</em><em>, </em><em>optional</em>) – Path to the existing fastp.sh script.
Defaults to “savio_jobs/fastp.sh”.</p></li>
</ul>
</dd>
<dt class="field-even">Raises<span class="colon">:</span></dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>FileNotFoundError</strong> – If the script_path does not exist.</p></li>
<li><p><strong>ValueError</strong> – If no .fastq.gz files are found in input_dir.</p></li>
</ul>
</dd>
</dl>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Creates a logs subdirectory in output_dir for SLURM job logs.</p>
</div>
<p class="rubric">Example</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">run_fastp</span><span class="p">(</span><span class="s2">&quot;/path/to/input&quot;</span><span class="p">,</span> <span class="s2">&quot;/path/to/output&quot;</span><span class="p">)</span>
<span class="go">Submitted SLURM array job for 10 files using /abs/path/fastp.sh.</span>
</pre></div>
</div>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="trebl_tools.preprocess.save_parquet">
<span class="sig-prename descclassname"><span class="pre">trebl_tools.preprocess.</span></span><span class="sig-name descname"><span class="pre">save_parquet</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">df</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">path</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/trebl_tools/preprocess.html#save_parquet"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#trebl_tools.preprocess.save_parquet" title="Link to this definition"></a></dt>
<dd><p>Save a DataFrame to a Parquet file with progress bar.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>df</strong> (<em>dask.DataFrame</em>) – DataFrame to save.</p></li>
<li><p><strong>path</strong> (<em>str</em>) – Path where the Parquet file will be saved.</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>None</p>
</dd>
</dl>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>If the path already exists, data will be appended to it.</p>
</div>
<p class="rubric">Example</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">save_parquet</span><span class="p">(</span><span class="n">my_dataframe</span><span class="p">,</span> <span class="s2">&quot;output.parquet&quot;</span><span class="p">)</span>
<span class="go">Warning: The path &#39;output.parquet&#39; already exists and will be added to.</span>
</pre></div>
</div>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="trebl_tools.preprocess.shorten_seq_file">
<span class="sig-prename descclassname"><span class="pre">trebl_tools.preprocess.</span></span><span class="sig-name descname"><span class="pre">shorten_seq_file</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">infile</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">outfile</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">chunk_size</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">400000</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/trebl_tools/preprocess.html#shorten_seq_file"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#trebl_tools.preprocess.shorten_seq_file" title="Link to this definition"></a></dt>
<dd><p>Extract sequences from FASTQ files to a text file (fastest method).</p>
<p>Extracts the 2nd line of each FASTQ record (sequence line) and writes
one sequence per line to the output file. Works with both plain and
gzipped FASTQ files.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>infile</strong> (<em>str</em>) – Input FASTQ or FASTQ.GZ file path.</p></li>
<li><p><strong>outfile</strong> (<em>str</em>) – Output text file path (1 sequence per line).</p></li>
<li><p><strong>chunk_size</strong> (<em>int</em><em>, </em><em>optional</em>) – Number of lines to read at once.
Must be multiple of 4. Defaults to 400000.</p></li>
</ul>
</dd>
</dl>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Progress is displayed using tqdm progress bar.</p>
</div>
<p class="rubric">Example</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">shorten_seq_file</span><span class="p">(</span><span class="s2">&quot;input.fastq.gz&quot;</span><span class="p">,</span> <span class="s2">&quot;sequences.txt&quot;</span><span class="p">)</span>
<span class="go">Shortening input.fastq.gz to sequences.txt...</span>
</pre></div>
</div>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="trebl_tools.preprocess.time_it">
<span class="sig-prename descclassname"><span class="pre">trebl_tools.preprocess.</span></span><span class="sig-name descname"><span class="pre">time_it</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">func</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/trebl_tools/preprocess.html#time_it"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#trebl_tools.preprocess.time_it" title="Link to this definition"></a></dt>
<dd><p>Decorator to print how long a method takes to run.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>func</strong> (<em>callable</em>) – The function to be decorated.</p>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>The wrapped function that prints execution time.</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>callable</p>
</dd>
</dl>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Time is displayed in seconds if less than 60 seconds, otherwise in minutes.</p>
</div>
</dd></dl>

</section>
<section id="module-trebl_tools.umi_deduplicate">
<span id="trebl-tools-umi-deduplicate-module"></span><h2>trebl_tools.umi_deduplicate module<a class="headerlink" href="#module-trebl_tools.umi_deduplicate" title="Link to this heading"></a></h2>
<dl class="py class">
<dt class="sig sig-object py" id="trebl_tools.umi_deduplicate.UMIDeduplicator">
<span class="property"><span class="k"><span class="pre">class</span></span><span class="w"> </span></span><span class="sig-prename descclassname"><span class="pre">trebl_tools.umi_deduplicate.</span></span><span class="sig-name descname"><span class="pre">UMIDeduplicator</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">db_path</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">bc_objects</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">step_name</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">descriptor</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">step1_map_name</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">fastq_path</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">output_path</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">refined_map_suffix</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/trebl_tools/umi_deduplicate.html#UMIDeduplicator"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#trebl_tools.umi_deduplicate.UMIDeduplicator" title="Link to this definition"></a></dt>
<dd><p>Bases: <code class="xref py py-class docutils literal notranslate"><span class="pre">object</span></code></p>
<p>Unified UMI Deduplication class combining simple counts and full UMI-tools pipeline.</p>
<p>This class provides comprehensive UMI (Unique Molecular Identifier) deduplication
functionality, supporting both simple counting methods and advanced UMI-tools
directional deduplication workflows.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>db_path</strong> (<em>str</em>) – Path to the DuckDB database file.</p></li>
<li><p><strong>bc_objects</strong> (<em>list</em>) – List of barcode objects with name and length attributes.</p></li>
<li><p><strong>step_name</strong> (<em>str</em>) – Name identifier for this processing step.</p></li>
<li><p><strong>descriptor</strong> (<em>str</em>) – Additional descriptor for table naming.</p></li>
<li><p><strong>step1_map_name</strong> (<em>str</em>) – Name of the step1 mapping table in the database.</p></li>
<li><p><strong>fastq_path</strong> (<em>str</em>) – Path to the input FASTQ file.</p></li>
<li><p><strong>output_path</strong> (<em>str</em>) – Directory path for output files.</p></li>
<li><p><strong>refined_map_suffix</strong> (<em>str</em>) – Suffix for the final refined mapping table (last step from map refiner).</p></li>
</ul>
</dd>
</dl>
<dl class="py attribute">
<dt class="sig sig-object py" id="trebl_tools.umi_deduplicate.UMIDeduplicator.db_path">
<span class="sig-name descname"><span class="pre">db_path</span></span><a class="headerlink" href="#trebl_tools.umi_deduplicate.UMIDeduplicator.db_path" title="Link to this definition"></a></dt>
<dd><p>Path to DuckDB database.</p>
<dl class="field-list simple">
<dt class="field-odd">Type<span class="colon">:</span></dt>
<dd class="field-odd"><p>str</p>
</dd>
</dl>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="trebl_tools.umi_deduplicate.UMIDeduplicator.con">
<span class="sig-name descname"><span class="pre">con</span></span><a class="headerlink" href="#trebl_tools.umi_deduplicate.UMIDeduplicator.con" title="Link to this definition"></a></dt>
<dd><p>Database connection object.</p>
<dl class="field-list simple">
<dt class="field-odd">Type<span class="colon">:</span></dt>
<dd class="field-odd"><p>duckdb.DuckDBPyConnection</p>
</dd>
</dl>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="trebl_tools.umi_deduplicate.UMIDeduplicator.bc_objects">
<span class="sig-name descname"><span class="pre">bc_objects</span></span><a class="headerlink" href="#trebl_tools.umi_deduplicate.UMIDeduplicator.bc_objects" title="Link to this definition"></a></dt>
<dd><p>Barcode objects.</p>
<dl class="field-list simple">
<dt class="field-odd">Type<span class="colon">:</span></dt>
<dd class="field-odd"><p>list</p>
</dd>
</dl>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="trebl_tools.umi_deduplicate.UMIDeduplicator.cols">
<span class="sig-name descname"><span class="pre">cols</span></span><a class="headerlink" href="#trebl_tools.umi_deduplicate.UMIDeduplicator.cols" title="Link to this definition"></a></dt>
<dd><p>List of barcode column names.</p>
<dl class="field-list simple">
<dt class="field-odd">Type<span class="colon">:</span></dt>
<dd class="field-odd"><p>list</p>
</dd>
</dl>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="trebl_tools.umi_deduplicate.UMIDeduplicator.step_name">
<span class="sig-name descname"><span class="pre">step_name</span></span><a class="headerlink" href="#trebl_tools.umi_deduplicate.UMIDeduplicator.step_name" title="Link to this definition"></a></dt>
<dd><p>Processing step identifier.</p>
<dl class="field-list simple">
<dt class="field-odd">Type<span class="colon">:</span></dt>
<dd class="field-odd"><p>str</p>
</dd>
</dl>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="trebl_tools.umi_deduplicate.UMIDeduplicator.table_prefix">
<span class="sig-name descname"><span class="pre">table_prefix</span></span><a class="headerlink" href="#trebl_tools.umi_deduplicate.UMIDeduplicator.table_prefix" title="Link to this definition"></a></dt>
<dd><p>Generated prefix for database tables.</p>
<dl class="field-list simple">
<dt class="field-odd">Type<span class="colon">:</span></dt>
<dd class="field-odd"><p>str</p>
</dd>
</dl>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="trebl_tools.umi_deduplicate.UMIDeduplicator.base">
<span class="sig-name descname"><span class="pre">base</span></span><a class="headerlink" href="#trebl_tools.umi_deduplicate.UMIDeduplicator.base" title="Link to this definition"></a></dt>
<dd><p>Base filename derived from FASTQ path.</p>
<dl class="field-list simple">
<dt class="field-odd">Type<span class="colon">:</span></dt>
<dd class="field-odd"><p>str</p>
</dd>
</dl>
</dd></dl>

<p class="rubric">Example</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">bc_objs</span> <span class="o">=</span> <span class="p">[</span><span class="n">barcode1</span><span class="p">,</span> <span class="n">barcode2</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">dedup</span> <span class="o">=</span> <span class="n">UMIDeduplicator</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">db_path</span><span class="o">=</span><span class="s2">&quot;data.db&quot;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">bc_objects</span><span class="o">=</span><span class="n">bc_objs</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">step_name</span><span class="o">=</span><span class="s2">&quot;trebl_experiment&quot;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">descriptor</span><span class="o">=</span><span class="s2">&quot;test&quot;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">step1_map_name</span><span class="o">=</span><span class="s2">&quot;step1_map&quot;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">fastq_path</span><span class="o">=</span><span class="s2">&quot;sample.fastq.gz&quot;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">output_path</span><span class="o">=</span><span class="s2">&quot;results/&quot;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">refined_map_suffix</span><span class="o">=</span><span class="s2">&quot;quality_designed&quot;</span>
<span class="gp">... </span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">merged_df</span> <span class="o">=</span> <span class="n">dedup</span><span class="o">.</span><span class="n">run_both_deduplications</span><span class="p">()</span>
</pre></div>
</div>
<dl class="py method">
<dt class="sig sig-object py" id="trebl_tools.umi_deduplicate.UMIDeduplicator.align_sort_and_deduplicate_umis">
<span class="sig-name descname"><span class="pre">align_sort_and_deduplicate_umis</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="_modules/trebl_tools/umi_deduplicate.html#UMIDeduplicator.align_sort_and_deduplicate_umis"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#trebl_tools.umi_deduplicate.UMIDeduplicator.align_sort_and_deduplicate_umis" title="Link to this definition"></a></dt>
<dd><p>Execute the complete UMI-tools alignment and deduplication pipeline.</p>
<p>Runs the full UMI-tools workflow:
1. Aligns FASTQ to barcode reference using bowtie2
2. Converts SAM to BAM format
3. Sorts and indexes BAM file
4. Deduplicates UMIs using UMI-tools directional method
5. Generates final count table
6. Cleans up intermediate files</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Requires conda environment with umi_tools and system modules for
bowtie2 and samtools. Uses 32 threads for alignment and sorting.
Creates and executes a temporary bash script for the pipeline.
All intermediate files are automatically cleaned up.</p>
</div>
<dl class="field-list simple">
<dt class="field-odd">Raises<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>subprocess.CalledProcessError</strong> – If any step in the pipeline fails.</p>
</dd>
</dl>
<p class="rubric">Example</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">dedup</span><span class="o">.</span><span class="n">align_sort_and_deduplicate_umis</span><span class="p">()</span>
<span class="go">Aligning .FASTQ to reference .FA ...</span>
<span class="go">Converting SAM -&gt; BAM ...</span>
<span class="go">Sorting BAM ...</span>
<span class="go">Indexing BAM ...</span>
<span class="go">Deduplicating UMIs ...</span>
<span class="go">Saving final counts...</span>
<span class="go">Cleaning up intermediate files...</span>
<span class="go">UMI workflow complete!</span>
<span class="go">Done in 5.23 minutes.</span>
</pre></div>
</div>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="trebl_tools.umi_deduplicate.UMIDeduplicator.counts_per_umi">
<span class="sig-name descname"><span class="pre">counts_per_umi</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="_modules/trebl_tools/umi_deduplicate.html#UMIDeduplicator.counts_per_umi"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#trebl_tools.umi_deduplicate.UMIDeduplicator.counts_per_umi" title="Link to this definition"></a></dt>
<dd><p>Return DataFrame with simple counts of each UMI per barcode combination.</p>
<dl class="field-list simple">
<dt class="field-odd">Returns<span class="colon">:</span></dt>
<dd class="field-odd"><p><dl class="simple">
<dt>DataFrame with columns for barcode(s), UMI, and read counts.</dt><dd><p>Sorted by barcode combinations and read counts (descending).</p>
</dd>
</dl>
</p>
</dd>
<dt class="field-even">Return type<span class="colon">:</span></dt>
<dd class="field-even"><p>pd.DataFrame</p>
</dd>
</dl>
<p class="rubric">Example</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">counts_df</span> <span class="o">=</span> <span class="n">dedup</span><span class="o">.</span><span class="n">counts_per_umi</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">counts_df</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>
<span class="go">   ADBC2  HawkBCs      UMI  reads</span>
<span class="go">0  AAAA      TTTT  ACGTACGT     15</span>
<span class="go">1  AAAA      TTTT  TGCATGCA      8</span>
</pre></div>
</div>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="trebl_tools.umi_deduplicate.UMIDeduplicator.generate_barcode_fasta_and_index">
<span class="sig-name descname"><span class="pre">generate_barcode_fasta_and_index</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">suffix</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'_barcodes'</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/trebl_tools/umi_deduplicate.html#UMIDeduplicator.generate_barcode_fasta_and_index"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#trebl_tools.umi_deduplicate.UMIDeduplicator.generate_barcode_fasta_and_index" title="Link to this definition"></a></dt>
<dd><p>Generate FASTA reference of unique barcodes and create bowtie2 index.
Used for UMI-tools directional deduplication workflow to align reads to barcode sequences.</p>
<p>Creates a FASTA file containing all unique concatenated barcode sequences
and builds a bowtie2 index for alignment. The FASTA file is removed after
indexing to save space.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>suffix</strong> (<em>str</em><em>, </em><em>optional</em>) – Suffix for FASTA filename. Defaults to “_barcodes”.</p>
</dd>
</dl>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Requires bowtie2 to be available via module system.
Uses 32 threads for index building (BOWTIE2_INDEX_BUILDER_THREADS).</p>
</div>
<p class="rubric">Example</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">dedup</span><span class="o">.</span><span class="n">generate_barcode_fasta_and_index</span><span class="p">(</span><span class="s2">&quot;_ref&quot;</span><span class="p">)</span>
<span class="go">Saving unique barcode(s) as reference file...</span>
<span class="go">Creating table of unique concatenated barcodes: trebl_experiment_ADBC2_unique_barcodes</span>
<span class="go">Writing FASTA to results/sample_ref.fa...</span>
<span class="go">Indexing FASTA with bowtie2-build, prefix: results/sample_ref_index</span>
<span class="go">Done in 5.67 seconds.</span>
</pre></div>
</div>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="trebl_tools.umi_deduplicate.UMIDeduplicator.generate_fastq">
<span class="sig-name descname"><span class="pre">generate_fastq</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">suffix</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'_umi_extracted.fastq'</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/trebl_tools/umi_deduplicate.html#UMIDeduplicator.generate_fastq"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#trebl_tools.umi_deduplicate.UMIDeduplicator.generate_fastq" title="Link to this definition"></a></dt>
<dd><p>Generate FASTQ file with UMIs in headers and concatenated barcodes as sequences.
Used for UMI-tools directional deduplication workflow.</p>
<p>Creates a FASTQ file where:
- Read ID contains the UMI sequence
- Read sequence is concatenated barcode columns
- Quality scores are placeholder ‘I’ characters</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>suffix</strong> (<em>str</em><em>, </em><em>optional</em>) – Suffix for output FASTQ filename.
Defaults to “_umi_extracted.fastq”.</p>
</dd>
</dl>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Only includes reads with valid UMI and barcode sequences.</p>
</div>
<p class="rubric">Example</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">dedup</span><span class="o">.</span><span class="n">generate_fastq</span><span class="p">(</span><span class="s2">&quot;_custom_suffix.fastq&quot;</span><span class="p">)</span>
<span class="go">Generating FASTQ with UMIs in header and barcodes as sequence...</span>
<span class="go">Writing FASTQ to results/sample_custom_suffix.fastq (1000 reads)...</span>
<span class="go">FASTQ complete: results/sample_custom_suffix.fastq</span>
<span class="go">Done in 1.23 seconds.</span>
</pre></div>
</div>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="trebl_tools.umi_deduplicate.UMIDeduplicator.merge_complex_with_step1_map">
<span class="sig-name descname"><span class="pre">merge_complex_with_step1_map</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">save</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">True</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/trebl_tools/umi_deduplicate.html#UMIDeduplicator.merge_complex_with_step1_map"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#trebl_tools.umi_deduplicate.UMIDeduplicator.merge_complex_with_step1_map" title="Link to this definition"></a></dt>
<dd><p>Merge UMI-tools directional deduplication results with step1 mapping table.</p>
<p>Reads the UMI-tools output TSV file and merges it with the step1 mapping
table on barcode columns. Renames columns to follow naming conventions.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>save</strong> (<em>bool</em><em>, </em><em>optional</em>) – Whether to save merged results to CSV.
Defaults to True.</p>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p><dl class="simple">
<dt>Merged DataFrame with directional UMI counts and</dt><dd><p>step1 mapping information.</p>
</dd>
</dl>
</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>pd.DataFrame</p>
</dd>
</dl>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Expects UMI-tools output file: {base}_directional_umi_counts.tsv</p>
</div>
<p class="rubric">Example</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">merged_df</span> <span class="o">=</span> <span class="n">dedup</span><span class="o">.</span><span class="n">merge_complex_with_step1_map</span><span class="p">(</span><span class="n">save</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="go">Saved to results/sample_ADBC2_HawkBCs_umis_directional_deduplic_with_step1_map.csv</span>
</pre></div>
</div>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="trebl_tools.umi_deduplicate.UMIDeduplicator.merge_simple_with_step1_map">
<span class="sig-name descname"><span class="pre">merge_simple_with_step1_map</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">save</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">True</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/trebl_tools/umi_deduplicate.html#UMIDeduplicator.merge_simple_with_step1_map"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#trebl_tools.umi_deduplicate.UMIDeduplicator.merge_simple_with_step1_map" title="Link to this definition"></a></dt>
<dd><p>Merge simple UMI counts with step1 mapping table.</p>
<p>Performs an inner join between the UMI count table and the step1 mapping
table on barcode columns. Filters out quality and designed columns.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>save</strong> (<em>bool</em><em>, </em><em>optional</em>) – Whether to save results to CSV file.
Defaults to True.</p>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p><dl class="simple">
<dt>Merged DataFrame with UMI counts and step1 mapping data.</dt><dd><p>Includes an ‘info’ column with the step_name value.</p>
</dd>
</dl>
</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>pd.DataFrame</p>
</dd>
</dl>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Removes columns named “Designed” and columns containing “_qual”.
CSV filename format: {base}_{barcode_cols}_umis_unique_with_step1_map.csv</p>
</div>
<p class="rubric">Example</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">merged_df</span> <span class="o">=</span> <span class="n">dedup</span><span class="o">.</span><span class="n">merge_simple_with_step1_map</span><span class="p">(</span><span class="n">save</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="go">Saved to results/sample_ADBC2_HawkBCs_umis_unique_with_step1_map.csv</span>
</pre></div>
</div>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="trebl_tools.umi_deduplicate.UMIDeduplicator.run_both_deduplications">
<span class="sig-name descname"><span class="pre">run_both_deduplications</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="_modules/trebl_tools/umi_deduplicate.html#UMIDeduplicator.run_both_deduplications"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#trebl_tools.umi_deduplicate.UMIDeduplicator.run_both_deduplications" title="Link to this definition"></a></dt>
<dd><p>Execute both simple and UMI-tools deduplication methods and merge results.</p>
<p>Runs both deduplication approaches:
1. Simple UMI counting (unique_umis_per_barcodes)
2. UMI-tools directional deduplication (run_umi_tools_deduplication)</p>
<p>Then merges both results with the step1 mapping table if available.</p>
<dl class="field-list simple">
<dt class="field-odd">Returns<span class="colon">:</span></dt>
<dd class="field-odd"><p><dl class="simple">
<dt>If step1_map_name is provided, returns merged</dt><dd><p>DataFrame with both deduplication results. Otherwise, saves
simple deduplication results only and returns None.</p>
</dd>
</dl>
</p>
</dd>
<dt class="field-even">Return type<span class="colon">:</span></dt>
<dd class="field-even"><p>pd.DataFrame or None</p>
</dd>
</dl>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This method provides comprehensive UMI analysis by comparing both
approaches. The merged output contains results from both methods
for comparison and validation.
Output filename: {base}_{barcode_cols}_umis_deduplic_with_step1_map.csv</p>
</div>
<p class="rubric">Example</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">merged_df</span> <span class="o">=</span> <span class="n">dedup</span><span class="o">.</span><span class="n">run_both_deduplications</span><span class="p">()</span>
<span class="go">Starting simple deduplication.</span>
<span class="go">Finished simple deduplication.</span>
</pre></div>
</div>
<p>Starting UMI Tools directional deduplication.
# … UMI-tools pipeline output …
Finished UMI Tools directional deduplication.</p>
<p>Saved to results/sample_ADBC2_HawkBCs_umis_deduplic_with_step1_map.csv</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="trebl_tools.umi_deduplicate.UMIDeduplicator.run_simple_deduplication">
<span class="sig-name descname"><span class="pre">run_simple_deduplication</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="_modules/trebl_tools/umi_deduplicate.html#UMIDeduplicator.run_simple_deduplication"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#trebl_tools.umi_deduplicate.UMIDeduplicator.run_simple_deduplication" title="Link to this definition"></a></dt>
<dd><p>Execute the simple UMI deduplication workflow.</p>
<p>Runs the basic UMI counting approach by calling unique_umis_per_barcodes().
This method only counts distinct UMIs per barcode combination without
considering UMI similarity or directional information.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This is the faster, simpler alternative to the full UMI-tools pipeline.
Results can be retrieved using merge_simple_with_step1_map() or
save_simple_deduplication().</p>
</div>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="trebl_tools.umi_deduplicate.UMIDeduplicator.run_umi_tools_deduplication">
<span class="sig-name descname"><span class="pre">run_umi_tools_deduplication</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="_modules/trebl_tools/umi_deduplicate.html#UMIDeduplicator.run_umi_tools_deduplication"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#trebl_tools.umi_deduplicate.UMIDeduplicator.run_umi_tools_deduplication" title="Link to this definition"></a></dt>
<dd><p>Execute the complete UMI-tools deduplication workflow.</p>
<p>Runs the full UMI-tools pipeline by calling:
1. generate_fastq() - Create FASTQ with UMIs in headers
2. generate_barcode_fasta_and_index() - Create reference and index
3. align_sort_and_deduplicate_umis() - Complete alignment and deduplication</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This is the comprehensive, slower method that uses UMI-tools
directional deduplication algorithm. Results in more accurate
deduplication compared to simple counting methods.</p>
</div>
<p class="rubric">Example</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">dedup</span><span class="o">.</span><span class="n">run_umi_tools_deduplication</span><span class="p">()</span>
<span class="go"># Executes complete pipeline automatically</span>
</pre></div>
</div>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="trebl_tools.umi_deduplicate.UMIDeduplicator.save_simple_deduplication">
<span class="sig-name descname"><span class="pre">save_simple_deduplication</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="_modules/trebl_tools/umi_deduplicate.html#UMIDeduplicator.save_simple_deduplication"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#trebl_tools.umi_deduplicate.UMIDeduplicator.save_simple_deduplication" title="Link to this definition"></a></dt>
<dd><p>Save simple UMI deduplication results to TSV files.</p>
<p>Saves two files:
1. Simple UMI counts per barcode combination
2. Read counts per individual UMI</p>
<dl class="field-list simple">
<dt class="field-odd">Returns<span class="colon">:</span></dt>
<dd class="field-odd"><p>DataFrame containing the simple UMI counts.</p>
</dd>
<dt class="field-even">Return type<span class="colon">:</span></dt>
<dd class="field-even"><p>pd.DataFrame</p>
</dd>
</dl>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Files are saved with tab separation (.tsv format).
Output filenames: {base}_simple_umi_counts.tsv and {base}_reads_per_umi.tsv
Execution time is automatically logged via &#64;time_it decorator.</p>
</div>
<p class="rubric">Example</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">result_df</span> <span class="o">=</span> <span class="n">dedup</span><span class="o">.</span><span class="n">save_simple_deduplication</span><span class="p">()</span>
<span class="go">Saved to results/sample_simple_umi_counts.tsv</span>
<span class="go">Saved to results/sample_reads_per_umi.tsv</span>
<span class="go">Done in 2.34 seconds.</span>
</pre></div>
</div>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="trebl_tools.umi_deduplicate.UMIDeduplicator.show_tables">
<span class="sig-name descname"><span class="pre">show_tables</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="_modules/trebl_tools/umi_deduplicate.html#UMIDeduplicator.show_tables"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#trebl_tools.umi_deduplicate.UMIDeduplicator.show_tables" title="Link to this definition"></a></dt>
<dd><p>Display all tables in the connected DuckDB database.</p>
<dl class="field-list simple">
<dt class="field-odd">Returns<span class="colon">:</span></dt>
<dd class="field-odd"><p>DataFrame listing all table names in the database.</p>
</dd>
<dt class="field-even">Return type<span class="colon">:</span></dt>
<dd class="field-even"><p>pd.DataFrame</p>
</dd>
</dl>
<p class="rubric">Example</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">tables_df</span> <span class="o">=</span> <span class="n">dedup</span><span class="o">.</span><span class="n">show_tables</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">tables_df</span><span class="p">)</span>
<span class="go">         name</span>
<span class="go">0  step1_map</span>
<span class="go">1  trebl_experiment_ADBC2_HawkBCs_quality_designed</span>
</pre></div>
</div>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="trebl_tools.umi_deduplicate.UMIDeduplicator.unique_umis_per_barcodes">
<span class="sig-name descname"><span class="pre">unique_umis_per_barcodes</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="_modules/trebl_tools/umi_deduplicate.html#UMIDeduplicator.unique_umis_per_barcodes"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#trebl_tools.umi_deduplicate.UMIDeduplicator.unique_umis_per_barcodes" title="Link to this definition"></a></dt>
<dd><p>Count unique UMIs per barcode combination and save as new table.</p>
<p>Creates a new table in the database containing the count of distinct UMIs
for each barcode combination.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This method creates a new table with suffix ‘_umis_collapsed’ and
sets the alias_name attribute to ‘count’ for the count column.</p>
</div>
<p class="rubric">Example</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">dedup</span><span class="o">.</span><span class="n">unique_umis_per_barcodes</span><span class="p">()</span>
<span class="go"># Creates table: trebl_experiment_ADBC2_HawkBCs_test_quality_designed_umis_collapsed</span>
</pre></div>
</div>
</dd></dl>

</dd></dl>

</section>
<section id="module-trebl_tools">
<span id="module-contents"></span><h2>Module contents<a class="headerlink" href="#module-trebl_tools" title="Link to this heading"></a></h2>
<p>TREBL Tools: Tools for TREBL analysis</p>
<p>Main classes for lab use:
- TreblPipeline: Run complete TREBL analysis workflows</p>
<dl class="py class">
<dt class="sig sig-object py" id="trebl_tools.TreblPipeline">
<span class="property"><span class="k"><span class="pre">class</span></span><span class="w"> </span></span><span class="sig-prename descclassname"><span class="pre">trebl_tools.</span></span><span class="sig-name descname"><span class="pre">TreblPipeline</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">db_path</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">design_file_path</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">error_correction</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">output_path</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">test_n_reads</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/trebl_tools/pipelines.html#TreblPipeline"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#trebl_tools.TreblPipeline" title="Link to this definition"></a></dt>
<dd><p>Bases: <code class="xref py py-class docutils literal notranslate"><span class="pre">object</span></code></p>
<p>End-to-end TREBL analysis pipeline orchestrator.</p>
<p>This class coordinates the complete TREBL workflow including initial barcode
mapping, quality filtering, error correction, UMI deduplication, and activity
score calculations. Supports both simple validation workflows and complex
experimental analyses with multiple samples and replicates.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>db_path</strong> (<em>str</em>) – Path to the DuckDB database file. Will be created if
it doesn’t exist.</p></li>
<li><p><strong>design_file_path</strong> (<em>str</em><em> or </em><em>None</em>) – Path to the design validation file.
If None, design-based filtering is skipped throughout the pipeline.</p></li>
<li><p><strong>error_correction</strong> (<em>bool</em><em>, </em><em>optional</em>) – Whether to enable UMI-tools based
error correction during refinement steps. Defaults to False.</p></li>
<li><p><strong>output_path</strong> (<em>str</em><em> or </em><em>Path</em><em>, </em><em>optional</em>) – Output directory for results,
figures, and intermediate files. If None, results are not saved
to disk. Defaults to None.</p></li>
<li><p><strong>test_n_reads</strong> (<em>int</em><em> or </em><em>bool</em><em>, </em><em>optional</em>) – If set to an integer, limits
initial mapping to the first N reads for rapid testing/debugging.
If False, processes all reads. Defaults to False.</p></li>
</ul>
</dd>
</dl>
<p class="rubric">Example</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Initialize pipeline for full experiment</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">pipeline</span> <span class="o">=</span> <span class="n">TreblPipeline</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">db_path</span><span class="o">=</span><span class="s2">&quot;experiment.duckdb&quot;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">design_file_path</span><span class="o">=</span><span class="s2">&quot;designs.csv&quot;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">error_correction</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">output_path</span><span class="o">=</span><span class="s2">&quot;results/&quot;</span>
<span class="gp">... </span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># Run Step 1: Initial barcode mapping</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">step1_df</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">run_step_1</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">seq_file</span><span class="o">=</span><span class="s2">&quot;step1_reads.fastq&quot;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">bc_objects</span><span class="o">=</span><span class="p">[</span><span class="n">ad_bc</span><span class="p">,</span> <span class="n">rep_bc</span><span class="p">],</span>
<span class="gp">... </span>    <span class="n">column_pairs</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;REP_BC&quot;</span><span class="p">,</span> <span class="s2">&quot;AD&quot;</span><span class="p">)],</span>
<span class="gp">... </span>    <span class="n">reads_threshold</span><span class="o">=</span><span class="mi">10</span>
<span class="gp">... </span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># Analyze full experiment with UMI deduplication</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">results</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">trebl_experiment_analysis</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">AD_seq_files</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;ad_sample1.fastq&quot;</span><span class="p">,</span> <span class="s2">&quot;ad_sample2.fastq&quot;</span><span class="p">],</span>
<span class="gp">... </span>    <span class="n">AD_bc_objects</span><span class="o">=</span><span class="p">[</span><span class="n">ad_bc</span><span class="p">,</span> <span class="n">adbc_bc</span><span class="p">],</span>
<span class="gp">... </span>    <span class="n">RT_seq_files</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;rt_sample1.fastq&quot;</span><span class="p">,</span> <span class="s2">&quot;rt_sample2.fastq&quot;</span><span class="p">],</span>
<span class="gp">... </span>    <span class="n">RT_bc_objects</span><span class="o">=</span><span class="p">[</span><span class="n">rt_bc</span><span class="p">],</span>
<span class="gp">... </span>    <span class="n">reverse_complement</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">AD_umi_object</span><span class="o">=</span><span class="n">umi_obj</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">RT_umi_object</span><span class="o">=</span><span class="n">umi_obj</span>
<span class="gp">... </span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># Calculate final activity scores</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">mean_activity</span><span class="p">,</span> <span class="n">summed_activity</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">calculate_activity_scores</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">step1_path</span><span class="o">=</span><span class="s2">&quot;results/step1.csv&quot;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">AD_bc_objects</span><span class="o">=</span><span class="p">[</span><span class="n">ad_bc</span><span class="p">,</span> <span class="n">adbc_bc</span><span class="p">],</span>
<span class="gp">... </span>    <span class="n">RT_bc_objects</span><span class="o">=</span><span class="p">[</span><span class="n">rt_bc</span><span class="p">],</span>
<span class="gp">... </span>    <span class="n">time_regex</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;(\d+)h&quot;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">rep_regex</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;rep(\d+)&quot;</span>
<span class="gp">... </span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The pipeline automatically handles table naming, intermediate file management,
and result aggregation across multiple samples. All processing steps are
logged and intermediate results are saved for debugging and validation.</p>
</div>
<dl class="py method">
<dt class="sig sig-object py" id="trebl_tools.TreblPipeline.__init__">
<span class="sig-name descname"><span class="pre">__init__</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">db_path</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">design_file_path</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">error_correction</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">output_path</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">test_n_reads</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/trebl_tools/pipelines.html#TreblPipeline.__init__"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#trebl_tools.TreblPipeline.__init__" title="Link to this definition"></a></dt>
<dd><p>Initialize a TREBL pipeline run.</p>
<p>Sets up database connection, output directories, and processing configuration.
Creates necessary directory structure for results and figures if output_path
is provided.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>db_path</strong> (<em>str</em>) – Path to the DuckDB database file. Will be created if
it doesn’t exist.</p></li>
<li><p><strong>design_file_path</strong> (<em>str</em><em> or </em><em>None</em>) – Path to the design validation file.
If None, design-based filtering is skipped throughout the pipeline.</p></li>
<li><p><strong>error_correction</strong> (<em>bool</em><em>, </em><em>optional</em>) – Whether to enable UMI-tools based
error correction during refinement steps. Defaults to False.</p></li>
<li><p><strong>output_path</strong> (<em>str</em><em> or </em><em>Path</em><em>, </em><em>optional</em>) – Output directory for results,
figures, and intermediate files. If None, results are not saved
to disk. Defaults to None.</p></li>
<li><p><strong>test_n_reads</strong> (<em>int</em><em> or </em><em>bool</em><em>, </em><em>optional</em>) – If set to an integer, limits
initial mapping to the first N reads for rapid testing/debugging.
If False, processes all reads. Defaults to False.</p></li>
</ul>
</dd>
</dl>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>When output_path is provided, creates subdirectories:
- {output_path}/figures/ for all plots and visualizations
- {output_path}/{sample_name}/ for per-sample intermediate files</p>
</div>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="trebl_tools.TreblPipeline.calculate_activity_scores">
<span class="sig-name descname"><span class="pre">calculate_activity_scores</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">step1_path</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">AD_bc_objects</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">RT_bc_objects</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">time_regex</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">rep_regex</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/trebl_tools/pipelines.html#TreblPipeline.calculate_activity_scores"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#trebl_tools.TreblPipeline.calculate_activity_scores" title="Link to this definition"></a></dt>
<dd><p>Compute activity scores from AD and RT experiment results using Step 1 mapping.</p>
<p>Calculates two complementary activity metrics by combining AD library UMI counts
(input) with RT library UMI counts (output) using the Step 1 barcode-to-gene
mapping as the linking table. Returns a consolidated table with both per-barcode
averaged activity and summed activity calculations.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>step1_path</strong> (<em>str</em>) – Path to the Step 1 mapping CSV file containing the
canonical barcode-to-gene relationships.</p></li>
<li><p><strong>AD_bc_objects</strong> (<em>list</em><em>[</em><a class="reference internal" href="#trebl_tools.finder.Barcode" title="trebl_tools.finder.Barcode"><em>Barcode</em></a><em>]</em>) – List of AD barcode objects with <cite>.name</cite>
attributes corresponding to columns in the Step 1 mapping.</p></li>
<li><p><strong>RT_bc_objects</strong> (<em>list</em><em>[</em><a class="reference internal" href="#trebl_tools.finder.Barcode" title="trebl_tools.finder.Barcode"><em>Barcode</em></a><em>]</em>) – List of RT barcode objects with <cite>.name</cite>
attributes for reporter identification.</p></li>
<li><p><strong>time_regex</strong> (<em>str</em>) – Regular expression to extract timepoint values from
sample names. Should contain a capture group for the time value.
Example: r”(d+)h” for “2h”, r”t(d+)” for “t24”.</p></li>
<li><p><strong>rep_regex</strong> (<em>str</em>) – Regular expression to extract replicate identifiers
from sample names. Should contain a capture group for replicate number.
Example: r”rep(d+)” for “rep1”, r”r(d+)” for “r2”.</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p><dl>
<dt>Consolidated activity scores table with hierarchical columns:</dt><dd><ul class="simple">
<li><p>Index: (AD, replicate) multi-index</p></li>
<li><dl class="simple">
<dt>Columns: Multi-level structure with:</dt><dd><ul>
<li><p>Level 0: timepoint values (e.g., 0, 2, 24)</p></li>
<li><p>Level 1: metric types (‘mean_activity’, ‘std_activity’, ‘summed_activity’)</p></li>
</ul>
</dd>
</dl>
</li>
</ul>
<dl>
<dt>Example structure:</dt><dd><blockquote>
<div><p>0                    2                    24</p>
</div></blockquote>
<p>mean  std  sum      mean  std  sum      mean  std  sum</p>
</dd>
</dl>
<p>AD    rep
GENE1  1      0.45  0.12  0.52    1.23  0.34  1.15    2.10  0.67  1.98</p>
<blockquote>
<div><p>2      0.48  0.15  0.55    1.18  0.29  1.12    2.05  0.71  1.95</p>
</div></blockquote>
</dd>
</dl>
</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>pd.DataFrame</p>
</dd>
</dl>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>Activity Score Calculations:</strong></p>
<ol class="arabic simple">
<li><dl class="simple">
<dt><strong>Averaged Activity (Per-Barcode)</strong>:</dt><dd><ul class="simple">
<li><p>For each barcode: activity = RT_UMIs / AD_UMIs</p></li>
<li><p>Mean and std calculated per (AD, time, rep) group</p></li>
<li><p>Results show variability across barcodes within each gene</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><strong>Summed Activity (Per-Gene)</strong>:</dt><dd><ul class="simple">
<li><p>For each (AD, time, rep): sum all AD_UMIs and RT_UMIs across barcodes</p></li>
<li><p>activity = sum(RT_UMIs) / sum(AD_UMIs)</p></li>
<li><p>Results show overall gene-level activity</p></li>
</ul>
</dd>
</dl>
</li>
</ol>
<p><strong>Output Files (if output_path configured):</strong>
- <cite>unaggregated_activities.csv</cite>: Raw per-barcode activity scores
- <cite>consolidated_activity_scores.csv</cite>: Combined table with all metrics</p>
<p><strong>Data Integration Workflow:</strong>
1. Load AD and RT experiment results from previous analysis
2. Extract time/replicate metadata using provided regex patterns
3. Merge with Step 1 mapping to link AD and RT measurements
4. Calculate per-barcode activity ratios
5. Aggregate using both averaging and summing strategies
6. Consolidate into single multi-level DataFrame</p>
</div>
<p class="rubric">Example</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">activity_df</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">calculate_activity_scores</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">step1_path</span><span class="o">=</span><span class="s2">&quot;results/step1.csv&quot;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">AD_bc_objects</span><span class="o">=</span><span class="p">[</span><span class="n">ad_bc</span><span class="p">,</span> <span class="n">adbc_bc</span><span class="p">],</span>
<span class="gp">... </span>    <span class="n">RT_bc_objects</span><span class="o">=</span><span class="p">[</span><span class="n">rt_bc</span><span class="p">],</span>
<span class="gp">... </span>    <span class="n">time_regex</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;(\d+)h&quot;</span><span class="p">,</span>          <span class="c1"># Extract &quot;24&quot; from &quot;24h&quot;</span>
<span class="gp">... </span>    <span class="n">rep_regex</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;rep(\d+)&quot;</span>          <span class="c1"># Extract &quot;1&quot; from &quot;rep1&quot;</span>
<span class="gp">... </span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Activity table shape:&quot;</span><span class="p">,</span> <span class="n">activity_df</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Available timepoints:&quot;</span><span class="p">,</span> <span class="n">activity_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Available metrics:&quot;</span><span class="p">,</span> <span class="n">activity_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
<span class="gp">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># Access specific metric for all timepoints</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">mean_activities</span> <span class="o">=</span> <span class="n">activity_df</span><span class="o">.</span><span class="n">xs</span><span class="p">(</span><span class="s1">&#39;mean_activity&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">summed_activities</span> <span class="o">=</span> <span class="n">activity_df</span><span class="o">.</span><span class="n">xs</span><span class="p">(</span><span class="s1">&#39;summed_activity&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<dl class="field-list simple">
<dt class="field-odd">Raises<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>ValueError</strong> – If regex patterns fail to match sample names</p></li>
<li><p><strong>FileNotFoundError</strong> – If required input CSV files are not found</p></li>
<li><p><strong>KeyError</strong> – If expected columns are missing from input files</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="trebl_tools.TreblPipeline.plot_trebl_experiment_loss">
<span class="sig-name descname"><span class="pre">plot_trebl_experiment_loss</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">bc_objects</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">step1_map_name</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">step_name_prefix</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'trebl_experiment_'</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/trebl_tools/pipelines.html#TreblPipeline.plot_trebl_experiment_loss"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#trebl_tools.TreblPipeline.plot_trebl_experiment_loss" title="Link to this definition"></a></dt>
<dd><p>Plot barcode quality and mapping loss for a TREBL experiment.</p>
<dl class="simple">
<dt>Generates bar plots showing:</dt><dd><ol class="arabic simple">
<li><p>Total number of reads in each initial mapping table.</p></li>
<li><p>Number of reads passing barcode quality checks (<cite>_qual</cite> columns).</p></li>
<li><p>Number of reads that match the Step 1 map for all barcodes.</p></li>
</ol>
</dd>
</dl>
<p>Plots are saved as a PNG file in <cite>self.output_figures_path</cite> and
returned as Matplotlib figure and axes objects.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>bc_objects</strong> (<em>list</em>) – List of barcode objects to evaluate.</p></li>
<li><p><strong>step1_map_name</strong> (<em>str</em>) – Name of the Step 1 DuckDB table used to
calculate overlap with mapped barcodes.</p></li>
<li><p><strong>step_name_prefix</strong> (<em>str</em><em>, </em><em>optional</em>) – Prefix used to identify TREBL
experiment tables in DuckDB. Defaults to “<a href="#id6"><span class="problematic" id="id7">trebl_experiment_</span></a>”.</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p><dl class="simple">
<dt>(fig, axes)</dt><dd><ul class="simple">
<li><p>fig (matplotlib.figure.Figure): Figure object containing all subplots.</p></li>
<li><p>axes (list[matplotlib.axes._subplots.AxesSubplot]): Flattened list of subplot axes.
Returns None, None if no matching tables are found.</p></li>
</ul>
</dd>
</dl>
</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>tuple</p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="trebl_tools.TreblPipeline.reads_distribution">
<span class="sig-name descname"><span class="pre">reads_distribution</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">seq_file</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">bc_objects</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">step_name</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">reverse_complement</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/trebl_tools/pipelines.html#TreblPipeline.reads_distribution"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#trebl_tools.TreblPipeline.reads_distribution" title="Link to this definition"></a></dt>
<dd><p>Visualize read-count distributions for threshold determination.</p>
<p>Performs initial mapping and grouping for a single FASTQ file and generates
a histogram showing the distribution of read counts per barcode combination.
This analysis helps determine appropriate read count thresholds for filtering.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>seq_file</strong> (<em>str</em>) – Path to FASTQ file containing sequences for analysis.</p></li>
<li><p><strong>bc_objects</strong> (<em>list</em><em>[</em><a class="reference internal" href="#trebl_tools.finder.Barcode" title="trebl_tools.finder.Barcode"><em>Barcode</em></a><em>]</em>) – Barcode objects defining extraction patterns
and expected lengths for the library.</p></li>
<li><p><strong>step_name</strong> (<em>str</em>) – Step identifier used for DuckDB table naming and
plot titles.</p></li>
<li><p><strong>reverse_complement</strong> (<em>bool</em>) – Whether sequences should be reverse
complemented prior to barcode extraction.</p></li>
</ul>
</dd>
</dl>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Creates grouped barcode combinations table and generates a read count
histogram. Useful for determining reads_threshold parameters before
running full refinement pipelines.</p>
</div>
<p class="rubric">Example</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">pipeline</span><span class="o">.</span><span class="n">reads_distribution</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">seq_file</span><span class="o">=</span><span class="s2">&quot;test_reads.fastq&quot;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">bc_objects</span><span class="o">=</span><span class="p">[</span><span class="n">ad_bc</span><span class="p">,</span> <span class="n">rep_bc</span><span class="p">],</span>
<span class="gp">... </span>    <span class="n">step_name</span><span class="o">=</span><span class="s2">&quot;threshold_test&quot;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">reverse_complement</span><span class="o">=</span><span class="kc">True</span>
<span class="gp">... </span><span class="p">)</span>
<span class="go"># Generates histogram showing read count distribution</span>
</pre></div>
</div>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="trebl_tools.TreblPipeline.run_step_1">
<span class="sig-name descname"><span class="pre">run_step_1</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">seq_file</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">bc_objects</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">column_pairs</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">reads_threshold</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">reverse_complement</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">step_suffix</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">''</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/trebl_tools/pipelines.html#TreblPipeline.run_step_1"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#trebl_tools.TreblPipeline.run_step_1" title="Link to this definition"></a></dt>
<dd><p>Run TREBL Step 1: map reads to designed AD barcodes.</p>
<p>Performs initial mapping, refinement, optional error correction,
and outputs the final designed map.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>seq_file</strong> (<em>str</em>) – FASTQ file containing Step 1 reads.</p></li>
<li><p><strong>bc_objects</strong> (<em>list</em>) – Barcode objects defining extraction rules.</p></li>
<li><p><strong>column_pairs</strong> (<em>list</em><em>[</em><em>tuple</em><em>]</em>) – <p>Column-pair checks used
to remove barcode collisions.</p>
<p>Each tuple has the form:</p>
<blockquote>
<div><p>(key_column(s), target_column(s))</p>
</div></blockquote>
<p>where <cite>key_column(s)</cite> and <cite>target_column(s)</cite> can be either
a single column name (str) or a tuple/list of column names.</p>
<p>The constraint enforces that, for each <strong>key</strong>, at least
90% of its reads must map to a single <strong>target</strong>. If a key
value maps to multiple targets without one reaching the 90%
threshold, the key is considered ambiguous and discarded.</p>
<p><strong>Single-column example</strong>:</p>
<blockquote>
<div><p>column_pairs = [(“RPTR_BC”, “AD”)]</p>
</div></blockquote>
<p>This ensures that each reporter barcode (<code class="docutils literal notranslate"><span class="pre">RPTR_BC</span></code>) maps
predominantly to a single AD. If a reporter barcode has
reads mapping to multiple ADs without one exceeding 90%,
that reporter barcode is removed.</p>
<p><strong>Multi-column example</strong>:</p>
<blockquote>
<div><dl class="simple">
<dt>column_pairs = [</dt><dd><p>((“RPTR_BC”), (“Hawk_BC”, “AD_BC”))</p>
</dd>
</dl>
<p>]</p>
</div></blockquote>
<p>This checks that each RPTR BC
maps to a single Hawkins AD barcode and AD barcode combination
with ≥90% of reads. Ambiguous key combinations are removed.</p>
<p>Multiple constraints may be applied sequentially:</p>
<blockquote>
<div><dl class="simple">
<dt>column_pairs = [</dt><dd><p>(“AD_BC”, “AD”),
(“RPTR_BC”, “AD”),
((“AD_BC”, “RPTR_BC”), (“AD”, “SampleID”)),</p>
</dd>
</dl>
<p>]</p>
</div></blockquote>
</p></li>
<li><p><strong>reads_threshold</strong> (<em>int</em>) – Minimum number of reads required for a
barcode or barcode pair to be kept.</p></li>
<li><p><strong>reverse_complement</strong> (<em>bool</em><em>, </em><em>optional</em>) – Whether reads should be
reverse complemented prior to barcode extraction.
Defaults to False.</p></li>
<li><p><strong>step_suffix</strong> (<em>str</em><em>, </em><em>optional</em>) – <p>Suffix appended to the step name
for DuckDB table naming. This is useful when you want
to distinguish multiple runs or subsets of the same step.</p>
<p class="rubric">Example</p>
<p>”_spike_in” — if processing spike-in samples separately
from your main dataset.
“_new_data” — for data from new sequencing run.</p>
</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>Final designed Step 1 mapping after all refinement
steps have been applied.</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>pd.DataFrame</p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="trebl_tools.TreblPipeline.run_step_2">
<span class="sig-name descname"><span class="pre">run_step_2</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">AD_seq_file</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">AD_bc_objects</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">RT_seq_file</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">RT_bc_objects</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">reverse_complement</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">reads_threshold_AD</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">reads_threshold_RT</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">step1_map_csv_path</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">step_suffix</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">''</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/trebl_tools/pipelines.html#TreblPipeline.run_step_2"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#trebl_tools.TreblPipeline.run_step_2" title="Link to this definition"></a></dt>
<dd><p>Run TREBL Step 2: Analyze intermediate complexity.</p>
<p>Performs separate refinement for AD and RT libraries and computes
overlap with the Step 1 map.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>AD_seq_file</strong> (<em>str</em>) – FASTQ file containing AD reads.</p></li>
<li><p><strong>AD_bc_objects</strong> (<em>list</em>) – Barcode objects for ADs.</p></li>
<li><p><strong>RT_seq_file</strong> (<em>str</em>) – FASTQ file containing RT reads.</p></li>
<li><p><strong>RT_bc_objects</strong> (<em>list</em>) – Barcode objects for reporters.</p></li>
<li><p><strong>reverse_complement</strong> (<em>bool</em>) – Whether to reverse complement reads.</p></li>
<li><p><strong>reads_threshold_AD</strong> (<em>int</em>) – Minimum reads per AD barcode.</p></li>
<li><p><strong>reads_threshold_RT</strong> (<em>int</em>) – Minimum reads per RT barcode.</p></li>
<li><p><strong>step1_map_csv_path</strong> (<em>str</em>) – Path to the Step 1 map CSV file.</p></li>
<li><p><strong>step_suffix</strong> (<em>str</em><em>, </em><em>optional</em>) – Suffix appended to the step name.</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p><dl class="simple">
<dt>Dictionary with keys:</dt><dd><ul class="simple">
<li><p>”AD_step2”: AD DataFrame</p></li>
<li><p>”RT_step2”: RT DataFrame</p></li>
<li><p>”step1_overlap”: Overlap statistics</p></li>
</ul>
</dd>
</dl>
</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>dict</p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="trebl_tools.TreblPipeline.step1_reads_distribution">
<span class="sig-name descname"><span class="pre">step1_reads_distribution</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">seq_file</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">bc_objects</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">reverse_complement</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">step_suffix</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">''</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/trebl_tools/pipelines.html#TreblPipeline.step1_reads_distribution"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#trebl_tools.TreblPipeline.step1_reads_distribution" title="Link to this definition"></a></dt>
<dd><p>Convenience wrapper for Step 1 read distributions.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>seq_file</strong> (<em>str</em>) – FASTQ file path.</p></li>
<li><p><strong>bc_objects</strong> (<em>list</em>) – Barcode objects.</p></li>
<li><p><strong>reverse_complement</strong> (<em>bool</em>) – Whether to reverse complement reads.</p></li>
<li><p><strong>step_suffix</strong> (<em>str</em><em>, </em><em>optional</em>) – Suffix appended to the step name.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="trebl_tools.TreblPipeline.step2_reads_distribution">
<span class="sig-name descname"><span class="pre">step2_reads_distribution</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">AD_seq_file</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">AD_bc_objects</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">RT_seq_file</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">RT_bc_objects</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">reverse_complement</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">step_suffix</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">''</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/trebl_tools/pipelines.html#TreblPipeline.step2_reads_distribution"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#trebl_tools.TreblPipeline.step2_reads_distribution" title="Link to this definition"></a></dt>
<dd><p>Convenience wrapper for Step 2 AD and RT libraries.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>AD_seq_file</strong> (<em>str</em>) – FASTQ file for AD reads.</p></li>
<li><p><strong>AD_bc_objects</strong> (<em>list</em>) – AD barcode objects.</p></li>
<li><p><strong>RT_seq_file</strong> (<em>str</em>) – FASTQ file for RT reads.</p></li>
<li><p><strong>RT_bc_objects</strong> (<em>list</em>) – RT barcode objects.</p></li>
<li><p><strong>reverse_complement</strong> (<em>bool</em>) – Whether to reverse complement reads.</p></li>
<li><p><strong>step_suffix</strong> (<em>str</em><em>, </em><em>optional</em>) – Suffix appended to the step name.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="trebl_tools.TreblPipeline.trebl_experiment_analysis">
<span class="sig-name descname"><span class="pre">trebl_experiment_analysis</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">AD_seq_files</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">AD_bc_objects</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">RT_seq_files</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">RT_bc_objects</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">reverse_complement</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">step1_map_csv_path</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">AD_umi_object</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">RT_umi_object</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">reads_threshold_AD</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">1</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">reads_threshold_RT</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">1</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">step_name_suffix</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">''</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">umi_deduplication</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'both'</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/trebl_tools/pipelines.html#TreblPipeline.trebl_experiment_analysis"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#trebl_tools.TreblPipeline.trebl_experiment_analysis" title="Link to this definition"></a></dt>
<dd><p>Run TREBL experiment analysis for both AD and RT libraries.</p>
<p>The workflow automatically selects between a UMI or non-UMI
pipeline depending on whether a UMI object is provided. If UMI deduplication
is enabled, results from simple and/or directional/complex deduplication are merged.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>AD_seq_files</strong> (<em>list</em><em>[</em><em>str</em><em>]</em>) – Paths to FASTQ files for AD library reads.</p></li>
<li><p><strong>AD_bc_objects</strong> (<em>list</em>) – Barcode objects for AD library extraction.</p></li>
<li><p><strong>RT_seq_files</strong> (<em>list</em><em>[</em><em>str</em><em>]</em>) – Paths to FASTQ files for reporter (RT) reads.</p></li>
<li><p><strong>RT_bc_objects</strong> (<em>list</em>) – Barcode objects for reporter library extraction.</p></li>
<li><p><strong>reverse_complement</strong> (<em>bool</em>) – Whether reads should be reverse complemented prior to barcode extraction.</p></li>
<li><p><strong>step1_map_csv_path</strong> (<em>str</em><em>, </em><em>optional</em>) – Path to Step 1 map CSV for computing overlap plots.</p></li>
<li><p><strong>AD_umi_object</strong> (<em>optional</em>) – UMI object for AD library. If provided, triggers UMI deduplication.</p></li>
<li><p><strong>RT_umi_object</strong> (<em>optional</em>) – UMI object for RT library. If provided, triggers UMI deduplication.</p></li>
<li><p><strong>reads_threshold_AD</strong> (<em>int</em><em>, </em><em>optional</em>) – Minimum reads per AD barcode to retain. Defaults to 1.</p></li>
<li><p><strong>reads_threshold_RT</strong> (<em>int</em><em>, </em><em>optional</em>) – Minimum reads per RT barcode to retain. Defaults to 1.</p></li>
<li><p><strong>step_name_suffix</strong> (<em>str</em><em>, </em><em>optional</em>) – Suffix for DuckDB table and output names.</p></li>
<li><p><strong>umi_deduplication</strong> (<em>str</em><em>, </em><em>optional</em>) – <p>Deduplication mode for both AD and RT libraries.
Options:</p>
<blockquote>
<div><ul>
<li><p>’simple’: Only simple UMI deduplication is applied.</p></li>
<li><p>’both’ (default): Both simple and directional/complex deduplication are performed.</p></li>
</ul>
</div></blockquote>
</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p><dl class="simple">
<dt>Dictionary containing final TREBL experiment results:</dt><dd><ul class="simple">
<li><p>”AD_results” (pd.DataFrame): AD library results with merged UMI counts if UMI workflow.</p></li>
<li><p>”RT_results” (pd.DataFrame): RT library results with merged UMI counts if UMI workflow.</p></li>
</ul>
</dd>
</dl>
</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>dict</p>
</dd>
</dl>
<p class="rubric">Notes</p>
<ul class="simple">
<li><p>UMI-based workflows produce two count tables per sample:</p></li>
</ul>
<p>simple UMI counts and directional/complex UMI counts. These are merged in the final output.
- Non-UMI workflows return barcode counts after grouping, thresholding, and optional error correction.
- If <cite>output_path</cite> is set, results are saved as CSV:</p>
<blockquote>
<div><p>“{output_path}/AD_trebl_experiment_results.csv” and
“{output_path}/RT_trebl_experiment_results.csv”.</p>
</div></blockquote>
<ul class="simple">
<li><p>Barcode quality/loss plots are generated for both AD and RT libraries.</p></li>
</ul>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="trebl_tools.TreblPipeline.trebl_experiment_reads_distribution">
<span class="sig-name descname"><span class="pre">trebl_experiment_reads_distribution</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">AD_seq_files</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">AD_bc_objects</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">RT_seq_files</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">RT_bc_objects</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">reverse_complement</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">step_suffix</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">''</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/trebl_tools/pipelines.html#TreblPipeline.trebl_experiment_reads_distribution"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#trebl_tools.TreblPipeline.trebl_experiment_reads_distribution" title="Link to this definition"></a></dt>
<dd><p>Convenience wrapper for TREBL Experiment AD and RT libraries.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>AD_seq_file</strong> (<em>str</em>) – FASTQ file for AD reads.</p></li>
<li><p><strong>AD_bc_objects</strong> (<em>list</em>) – AD barcode objects.</p></li>
<li><p><strong>RT_seq_file</strong> (<em>str</em>) – FASTQ file for RT reads.</p></li>
<li><p><strong>RT_bc_objects</strong> (<em>list</em>) – RT barcode objects.</p></li>
<li><p><strong>reverse_complement</strong> (<em>bool</em>) – Whether to reverse complement reads.</p></li>
<li><p><strong>step_suffix</strong> (<em>str</em><em>, </em><em>optional</em>) – Suffix appended to the step name.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

</dd></dl>

</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="modules.html" class="btn btn-neutral float-left" title="trebl_tools" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2026, Staller Lab.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>